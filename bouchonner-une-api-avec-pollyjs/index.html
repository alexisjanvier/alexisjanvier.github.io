<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:125%/1.5 'PT Sans',sans-serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.8);font-family:'PT Sans',sans-serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;color:hsla(0,0%,0%,0.9);font-family:'Oswald',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:2rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;color:hsla(0,0%,0%,0.9);font-family:'Oswald',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1.51572rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;color:hsla(0,0%,0%,0.9);font-family:'Oswald',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1.31951rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;color:hsla(0,0%,0%,0.9);font-family:'Oswald',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;color:hsla(0,0%,0%,0.9);font-family:'Oswald',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:0.87055rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;color:hsla(0,0%,0%,0.9);font-family:'Oswald',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:0.81225rem;line-height:1.1;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}ul{margin-left:1.5rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;list-style-position:outside;list-style-image:none;}ol{margin-left:1.5rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;font-size:0.85rem;line-height:1.5rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;font-size:1rem;line-height:1.5rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}blockquote{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0.9375rem;padding-right:0;padding-top:0;margin-bottom:1.5rem;font-size:1.1487rem;line-height:1.5rem;border-left:0.5625rem solid #292d35;color:hsla(0,0%,0%,0.65);font-style:italic;}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.5rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.5rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.5rem;margin-bottom:calc(1.5rem / 2);margin-top:calc(1.5rem / 2);}li > ul{margin-left:1.5rem;margin-bottom:calc(1.5rem / 2);margin-top:calc(1.5rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.5rem / 2);}code{font-size:0.85rem;line-height:1.5rem;}kbd{font-size:0.85rem;line-height:1.5rem;}samp{font-size:0.85rem;line-height:1.5rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1rem;padding-right:1rem;padding-top:0.75rem;padding-bottom:calc(0.75rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}a{color:#292d35;text-decoration:none;text-shadow:.03em 0 #fff,-.03em 0 #fff,0 .03em #fff,0 -.03em #fff,.06em 0 #fff,-.06em 0 #fff,.09em 0 #fff,-.09em 0 #fff,.12em 0 #fff,-.12em 0 #fff,.15em 0 #fff,-.15em 0 #fff;background-image:linear-gradient(to top, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0) 1px, #292d35 1px, #292d35 2px, rgba(0, 0, 0, 0) 2px);}a:hover,a:active{text-shadow:none;background-image:none;}h1,h2,h3,h4,h5,h6{margin-top:3rem;}blockquote > :last-child{margin-bottom:0;}blockquote cite{font-size:1rem;line-height:1.5rem;color:hsla(0,0%,0%,0.8);font-style:normal;font-weight:400;}blockquote cite:before{content:"— ";}@media only screen and (max-width:480px){html{font-size:106.25%;line-height:24.65px;}blockquote{border-left:0.28125rem solid #292d35;color:hsla(0,0%,0%,0.59);padding-left:0.84375rem;font-style:italic;margin-left:-1.125rem;margin-right:0;}}</style><style data-href="/styles.9049d68c607a167417b5.css">header h3,header h5{display:inline-block;padding-right:.5rem;margin-top:0}header a{text-shadow:none;background-image:none;text-decoration:none;vertical-align:middle}header a:hover{color:red}header a img{vertical-align:middle}.blog-list a:hover{color:#000}.blog-list h2,.blog-list h4{margin-bottom:.5rem}.blog-list h4{font-style:italic;margin-top:0}.blog-list h4 span{display:inline-block;color:grey;font-size:.8rem}.postIntro h1{font-size:2.5rem;width:100%;text-align:center;margin-top:1rem;margin-bottom:.5rem}.postIntro p.tags{font-size:.8rem;color:grey;margin:0;text-align:center}.postIntro p.date{margin:0 0 1rem;text-align:center}.postIntro p.intro{margin-top:1.5rem;font-style:italic}code[class*=language-],pre[class*=language-]{color:#ccc;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}</style><meta name="generator" content="Gatsby 2.3.4"/><link href="//fonts.googleapis.com/css?family=Oswald:700|PT+Sans:400,400i,700" rel="stylesheet" type="text/css"/><link rel="stylesheet" href="https://github.githubassets.com/assets/gist-embed-b3b573358bfc66d89e1e95dbf8319c09.css"/><title data-react-helmet="true">Bouchonner une API avec Polly.js</title><meta data-react-helmet="true" name="author" content="Àlexis Janvier"/><meta data-react-helmet="true" itemProp="image" content="https://www.alexisjanvier.net/covers/ajnet.jpg"/><meta data-react-helmet="true" property="og:image" content="https://www.alexisjanvier.net/covers/ajnet.jpg"/><meta data-react-helmet="true" name="twitter:image" content="https://www.alexisjanvier.net/covers/ajnet.jpg"/><meta data-react-helmet="true" name="description" content="Ce n&#x27;est jamais simple de mettre en place des tests fonctionnels impliquant une base de données ou des appels à une API externe. Si Polly.js ne résout pas le problème de la base de données, c&#x27;est un outil utile à connaitre pour bouchonner des appels vers une API."/><meta data-react-helmet="true" name="keywords" content="javascript,tests"/><meta data-react-helmet="true" itemProp="name" content="Bouchonner une API avec Polly.js"/><meta data-react-helmet="true" itemProp="description" content="Ce n&#x27;est jamais simple de mettre en place des tests fonctionnels impliquant une base de données ou des appels à une API externe. Si Polly.js ne résout pas le problème de la base de données, c&#x27;est un outil utile à connaitre pour bouchonner des appels vers une API."/><meta data-react-helmet="true" property="og:title" content="Bouchonner une API avec Polly.js"/><meta data-react-helmet="true" property="og:description" content="Ce n&#x27;est jamais simple de mettre en place des tests fonctionnels impliquant une base de données ou des appels à une API externe. Si Polly.js ne résout pas le problème de la base de données, c&#x27;est un outil utile à connaitre pour bouchonner des appels vers une API."/><meta data-react-helmet="true" property="og:url" content="https://www.alexisjanvier.net/bouchonner-une-api-avec-pollyjs"/><meta data-react-helmet="true" property="og:site_name" content="alexisjanvier.net"/><meta data-react-helmet="true" name="twitter:title" content="Bouchonner une API avec Polly.js"/><meta data-react-helmet="true" name="twitter:description" content="Ce n&#x27;est jamais simple de mettre en place des tests fonctionnels impliquant une base de données ou des appels à une API externe. Si Polly.js ne résout pas le problème de la base de données, c&#x27;est un outil utile à connaitre pour bouchonner des appels vers une API."/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" name="twitter:image:alt" content="Bouchonner une API avec Polly.js"/><meta data-react-helmet="true" name="twitter:creator" content="@alexisjanvier"/><meta data-react-helmet="true" name="twitter:site" content="@alexisjanvier"/><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link as="script" rel="preload" href="/webpack-runtime-5c4d75ee9233b0c60d72.js"/><link as="script" rel="preload" href="/app-6c5376e06f2d7e34c5c3.js"/><link as="script" rel="preload" href="/styles-7d82cead6d54fb5cd7e1.js"/><link as="script" rel="preload" href="/1-2dea483b5ed5e468183a.js"/><link as="script" rel="preload" href="/2-0e0f7c0717f48b96baf5.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-a3c7316724bb72f3a7bc.js"/><link as="fetch" rel="preload" href="/static/d/891/path---bouchonner-une-api-avec-pollyjs-c-29-2f2-cExi8Ie1B86iaS2F28uDaRTI.json" crossorigin="use-credentials"/></head><body><noscript id="gatsby-noscript">This app works best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><header><div style="margin:0 auto;max-width:1000px;padding:1.25rem 1rem"><header style="margin-bottom:1.5rem"><a href="/"><h3>This is not &#x27;Nam.</h3><h5>This is web development. There are rules.</h5></a><ul style="list-style:none;float:right"><li style="display:inline-block;margin-right:1rem"><a href="/">Blog</a></li><li style="display:inline-block;margin-right:1rem"><a href="/about/">About</a></li><li style="display:inline-block;margin-right:1rem"><a href="https://twitter.com/alexisjanvier"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAQAAADZc7J/AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAAmJLR0QA/4ePzL8AAAAJcEhZcwAAAjcAAAI3AfcGRMIAAAAHdElNRQfhCQEKGCQX757NAAACjElEQVRIx62VX0hTURzHP/e6NRkYLREcrLeCfFDBGL4UiWGJL+sP9FLkQ4FR7MGHhHTe251OqRBJX6qXIBDCelCQIAYS9CSVBCsHFT3EaIIxs8HYmnp72N28/zYn+Hs653fO93Pv7/x+5/wEFatNu9Y71QBNePECSZLEhXnPYjBn3SuYAWPevMQV6my4aWac4cFkBYBSS4h+3JS3DJOMyllbgNLIHO3sbkucl1ctgJHm7df4qpADJMSe4ZgBoDTyvmo5QAJ/4S9ELfa5PcnBx5xSWwIQqhj7Jo+Fy5wRBvgBQIy/QDshLYQxb/67dvKPOEWbSZ7inPyhMHxQl72lRnHzrpAR59HBpAh5qZS4Wbr4aALcLsphIC3d5w+XeAOAOy+BMOVKrZXK5oicmHalJAZwaJ4N2YOp1sIB9ZW2nj7cIK536qruJARz8pDYxlM2APhslo+cUGdL+Lr1TlEN6FZ7X9YADMfkPhqFs/SzYD7RbT8HdmZqwEGTbjUWv8GTwlDOEiVqk5MWw6zJgVc3fSEt71oBrYaZVzQAru8qF2g2A/TWp1ysrB89br7oIvr7XcNzZWK8oTxgK2JyJI0AyPDw7lo5udLNBSsgbnA08AzBXj7tYsrijIvCvMnVrSyH7yg2dzM1yDHLmc6LnkXSJm+r2oJo3qqEkCzMtGfREcwpM9wE4Be/WeELC/In477x+n8T9NpENRPMOcAZzl/DDRxklkn5p+nLh7jKPept5BlnWHvSlFGGNOcmUVaEb3xVt/Dh4zRdOMskJSKHioBa3lb1HuttiQ45u1+PKsirYg+J6uViT7EzlNI1HMPPUpU/7y92BfT5llfpIEKmojhDhI6dvrTfzbVoe2nv/wH5+trdc83aGwAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAxNy0wOS0wMVQxMDoyNDozNiswMjowMORVb1wAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMTctMDktMDFUMTA6MjQ6MzYrMDI6MDCVCNfgAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAAA10RVh0VGl0bGUAVHdpdHRlcpMAsEgAAABXelRYdFJhdyBwcm9maWxlIHR5cGUgaXB0YwAAeJzj8gwIcVYoKMpPy8xJ5VIAAyMLLmMLEyMTS5MUAxMgRIA0w2QDI7NUIMvY1MjEzMQcxAfLgEigSi4A6hcRdPJCNZUAAAAASUVORK5CYII="/></a></li><li style="display:inline-block;margin-right:1rem"><a href="https://github.com//alexisjanvier"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAQAAADZc7J/AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAAmJLR0QA/4ePzL8AAAAJcEhZcwAAAjcAAAI3AfcGRMIAAAAHdElNRQfhCQEKFycJftO4AAAC2ElEQVRIx62VTUhUURTHf/c10/hJ+VH6wtqVWhi0qHEhItIiKhzbtCncRFSLWQhRJubrjTqLXAjZoqKPlVA7B0JXCUIIOqiLIkcNizRGEfxoBptpdF6LefPmOTM5Cp3NOx/3/7/3nHfPPUIjVXptq/Wag0pkZMCPnynhKRhyhlPXimQCtxxp5xr5aXgD9Fldrf4dCNQs2mgmh3/LBj10KqG0BGop/djZWZYpZoxGZTHukOJKRxVe7CyTi4O3bKTZ+zV25TAj2PF2VCWdQC3FSxkwrVQAPM7/7RRLzO2bs6yFiigWR7Vx5TuA+pIbwAJnY6ew6Ln3U2be7l4At2GsM8eYseO0BlBGv1qnhOIptGXMPSFR/WunTa+BW6bZCE9mwmuvmNfVZrcMEkTajR8XsrRkIlDWxANdzYm0g3hiW1k2rs0L5VbmHHptK8FY7QgUHpJW6023bj4zHJxhvuhq/mq9pDlMsbVdFtK4JZpDojLhF7m7JMgztEoJ2VThwj0TyBZkQCPICjMs7ZLgJ0EKKMGCHO+FLbKpoEE9kRmtXmCdTfbHLqF4NMNxU/QH9kSnpYWfY4Aiw5yV2P5AHGPCdWnH3T+Y4OC3MEWtbgQZ5DKy9l79iEcajM4qfwxglnQm6uAKySlOScKTqK0YphofUEN39DPXE+vEjegI91PgCI9UMEQgbmrd0pbUxCwAXuVNYqH2HF+ajAIFQ5IzTJ/hyI6+s36lDid3qEVTs0C9C2qOssl4GoI+Z9gCVlekyejHU+FnttstT3XrJBPkAdUM8SsFvmF1gQStfnpM7qvhb6pP9bluAqd1Xw0kEjWkp9Uff5E6GTUFDlBOuVYEokT3HOm1kTxARukEnUAJ0chCaoqaiGsrgqxtoQUaY9PBmAsdVdGBbQ/rOsMcZJDzTNJAIcVmuHTx4Sf9R+5xsMQOn26wgLJIHV1pRsq2ytNFnblb/u9wjctexvtf2qD0QeZRdFEAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTctMDktMDFUMTA6MjM6MzkrMDI6MDDwwQTMAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE3LTA5LTAxVDEwOjIzOjM5KzAyOjAwgZy8cAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAMdEVYdFRpdGxlAEdpdEh1YlTKy1sAAABXelRYdFJhdyBwcm9maWxlIHR5cGUgaXB0YwAAeJzj8gwIcVYoKMpPy8xJ5VIAAyMLLmMLEyMTS5MUAxMgRIA0w2QDI7NUIMvY1MjEzMQcxAfLgEigSi4A6hcRdPJCNZUAAAAASUVORK5CYII="/></a></li></ul></header><div><div class="postIntro"><h1>Bouchonner une API avec Polly.js</h1><p class="date">Publié le <!-- -->09 octobre 2019</p></div><div><p>Une solution simple à mettre en place lors de la création de tests fonctionnels sur une API dépendant elle-même d'appels à une autre API consiste à créer des fixtures. Il suffit alors de mettre en place un mock du client à cette API, mock qui se chargera de renvoyer des fixtures. Un petit exemple avec <a href="https://jestjs.io/">Jest</a>, <a href="https://github.com/visionmedia/supertest">supertest</a> et un client d'API basé sur <a href="https://github.com/axios/axios">axios</a>:</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// in apiClient.js</span>
<span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> config <span class="token keyword">from</span> <span class="token string">'../path-to/config'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">apiClientFactory</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">httpClient<span class="token punctuation">,</span> token</span><span class="token punctuation">)</span>  <span class="token operator">=></span>  httpClient<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    baseURL<span class="token punctuation">:</span> config<span class="token punctuation">.</span>baseUrl<span class="token punctuation">,</span>
    timeout<span class="token punctuation">:</span> config<span class="token punctuation">.</span>timeout<span class="token punctuation">,</span>
    headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        Authorization<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`Bearer </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span>
        <span class="token operator">...</span>headers<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> apiClient <span class="token operator">=</span> <span class="token function">apiClientFactory</span><span class="token punctuation">(</span>axios<span class="token punctuation">,</span> config<span class="token punctuation">.</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// in router.js</span>
<span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> apiClient <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./apiClient'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> apiRouter <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

apiRouter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/:objectId'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> resp</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> objectId <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> body<span class="token punctuation">:</span> object <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> apiClient<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`/object/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>objectId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Object </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>objectId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> not found`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// in createRequest.js</span>
<span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> request <span class="token keyword">from</span> <span class="token string">'supertest'</span><span class="token punctuation">;</span>


<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">createRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// The application router must be importer after the clients mocks</span>
    <span class="token keyword">const</span> apiRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./router'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> apiRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">request</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// in router.spec.js</span>
<span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> createRequest <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./createRequest'</span><span class="token punctuation">;</span>

jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'axios'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> objectFixture <span class="token operator">=</span> <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token string">'uuid'</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> <span class="token string">'object name'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Object API endpoint'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'GET /objectId'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should return an object from external API'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            axios<span class="token punctuation">.</span>get<span class="token punctuation">.</span><span class="token function">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data<span class="token punctuation">:</span> objectFixture <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> request <span class="token operator">=</span> <span class="token function">createRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> request<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/uuid'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> status<span class="token punctuation">,</span> body <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                <span class="token function">expect</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">expect</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span>title<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token string">'object name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Mais cela peut devenir rapidement fastidieux de créer ces fixtures et surtout de les maintenir. Sur l'un de nos projet client, nous avions une API testée fonctionnellement et dépendante de deux API. Lorsque une troisième API a été implémenté, nous en avons profité pour changer notre stratégie de mock. Nous nous sommes tourné vers <a href="https://netflix.github.io/pollyjs/#/">Polly.js</a>, une librairie maintenue par Netflix, qui permet d'enregistrer tous les appels fait à une ou plusieurs API en mode <code class="language-text">RECORD</code> et de les rejouer en mode <code class="language-text">REPLAY</code>. Voici le retour d'expérience de cette implémentation.</p>
<h2>Première Mise en Place</h2>
<p>Ce billet n'est pas un tutoriel, il ne s'attarde donc pas sur les modalités de mise en place de Polly. Et d'ailleurs, le projet possède une <a href="https://netflix.github.io/pollyjs/#/README">très bonne documentation</a>.</p>
<p>Les tests étant effectués sur une API réalisée en Node, nous avons utilisé l'<a href="https://www.npmjs.com/package/@pollyjs/adapter-node-http">adapter-node-http</a>, et nous avons choisi de stocker les enregistrements sur l'hôte de la machine avec le <a href="https://www.npmjs.com/package/@pollyjs/persister-fs">persister-fs</a>. Les tests étant gérés par Jest, nous avons aussi utilisé <a href="https://www.npmjs.com/package/setup-polly-jest">setup-polly-jest</a>. En repartant de l'exemple d'introduction, voila ce que cela donne :</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// in setupPolly.js</span>
<span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">'path'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> NodeHttpAdapter <span class="token keyword">from</span> <span class="token string">'@pollyjs/adapter-node-http'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Polly <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@pollyjs/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> FSPersister <span class="token keyword">from</span> <span class="token string">'@pollyjs/persister-fs'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">MODES</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@pollyjs/utils'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> setupPolly <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'setup-polly-jest'</span><span class="token punctuation">;</span>

Polly<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>NodeHttpAdapter<span class="token punctuation">)</span><span class="token punctuation">;</span>
Polly<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>FSPersister<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">startPolly</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>
    <span class="token function">setupPolly</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        mode<span class="token punctuation">:</span> <span class="token constant">MODES</span><span class="token punctuation">.</span><span class="token constant">REPLAY</span><span class="token punctuation">,</span>
        recordIfMissing<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">POLLY_RECORD</span> <span class="token operator">||</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        adapters<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'node-http'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        persister<span class="token punctuation">:</span> <span class="token string">'fs'</span><span class="token punctuation">,</span>
        persisterOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            fs<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                recordingsDir<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./recordings'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">describePolly</span> <span class="token operator">=</span> <span class="token parameter">string</span> <span class="token operator">=></span> string<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\//g</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// in router.spec.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createRequest <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./createRequest'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> describePolly<span class="token punctuation">,</span> setupPolly <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./setupPolly'</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Object API endpoint'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setupPolly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">describe</span><span class="token punctuation">(</span><span class="token function">describePolly</span><span class="token punctuation">(</span><span class="token string">'GET /objectId'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should return an object from external API'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> request <span class="token operator">=</span> <span class="token function">createRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> request<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/uuid'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> status<span class="token punctuation">,</span> body <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                <span class="token function">expect</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">expect</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span>title<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token string">'real name from real api call'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Tout d'abord, Polly doit-être lancer durant les tests. Il faut donc logiquement lancer le setupPolly à l'intérieur d'un <code class="language-text">describe</code>.</p>
<p>Ensuite, Polly sauvegarde ses enregistrements (au format <code class="language-text">.har</code>) en les organisant dans des répertoires respectant l'imbrication des <code class="language-text">describe</code> et <code class="language-text">it</code> des tests. C'est pour cela que l'on utilise la méthode <code class="language-text">describePolly</code>, qui dans le cas d'une description de tests prenant la forme d'une url d'api, va transformer les <code class="language-text">/</code> en <code class="language-text">-</code>. Sans quoi, on se retrouve avec une infernale imbrication de répertoires ...</p>
<p>Par exemple, pour un test prenant la forme :</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'my test'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'/domain/subdomain/api/object/id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token comment">// test</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>On aura un enregistrement sous la forme :</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token keyword">.</span>
├── my-test
│   └── domain
│       └── subdomain
│           └── api
│               └── object
│                   └── <span class="token function">id</span>
│                       └── my-record.har</code></pre></div>
<p>En utilisant <code class="language-text">pollyDescribe</code></p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'my test'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token function">pollyDescribe</span><span class="token punctuation">(</span><span class="token string">'/domain/subdomain/api/object/id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token comment">// test</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>On aura un enregistrement sous la forme :</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token keyword">.</span>
├── my-test
│   └── domain-subdomaine-api-object-id
│       └── my-record.har</code></pre></div>
<p>Et enfin, on utilise une variable d'environnement <code class="language-text">POLLY_RECORD</code> pour lancer l'enregistrement des appels API manquant lors de la mise en place des tests. Cette variable d'environnement n'existera pas sur le serveur d'intégration continue.</p>
<h2>Premières Erreurs</h2>
<p>Si les premiers enregistrements se passent bien (<code class="language-text">POLLY_RECORD=true yarn test</code>) - on voit bien les fichiers <code class="language-text">.har</code> dans le répertoire recordings - c'est moins convaincant en mode replay (<code class="language-text">yarn test</code>). </p>
<p>En effet, les tests semblent devenir aléatoires : un coup vert, un coup rouge avec cette erreur :</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">PollyError: <span class="token punctuation">[</span>Polly<span class="token punctuation">]</span> <span class="token punctuation">[</span>adapter:node-http<span class="token punctuation">]</span> Recording <span class="token keyword">for</span> the following request is not found and <span class="token variable"><span class="token variable">`</span>recordIfMissing<span class="token variable">`</span></span> is <span class="token variable"><span class="token variable">`</span><span class="token boolean">false</span><span class="token variable">`</span></span><span class="token keyword">.</span></code></pre></div>
<p>Si la solution de ce problème est simple, nous avons tout de même mis un peu de temps à la trouver ... En se plongeant de la documentation de la <a href="https://netflix.github.io/pollyjs/#/configuration">configuration de Polly</a>, on se rend compte que l'on peut jouer sur beaucoup de paramètres permettant d'identifier un enregistrement. Et notamment, on peut identifier ou non un enregistrement selon le port de l'appel à l'API (ce qui est le cas d'une configuration par défault).</p>
<p>Hors, nous utilisons <code class="language-text">supertest</code>. Sans rentrer dans les détails de son fonctionnement, <code class="language-text">supertest</code> lance une instance de serveur à chaque appel à la fonction <code class="language-text">getRequest()</code>. Pour ne pas risquer d'ouvrir deux serveurs sur le même port, par exemple si on lance les tests en parallèle, il lance les serveurs sur des ports aléatoire ! </p>
<p>Ce qui explique l'instabilité des tests: parfois on a de la chance et le serveur est lancé sur le même port qu'un enregistrement - le test est vert - ; parfois non - le test est rouge -.</p>
<p>Il faut donc exclure le port des identifiants d'enregistrement :</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// in setupPolly.js</span>
<span class="token comment">// [...]</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">startPolly</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>
    <span class="token function">setupPolly</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        mode<span class="token punctuation">:</span> <span class="token constant">MODES</span><span class="token punctuation">.</span><span class="token constant">REPLAY</span><span class="token punctuation">,</span>
        recordIfMissing<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">POLLY_RECORD</span> <span class="token operator">||</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        adapters<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'node-http'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        persister<span class="token punctuation">:</span> <span class="token string">'fs'</span><span class="token punctuation">,</span>
        persisterOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            fs<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                recordingsDir<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./recordings'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        matchRequestsBy<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            method<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            headers<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            body<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            order<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            url<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                protocol<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                username<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                password<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                hostname<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                port<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                pathname<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                query<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                hash<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Cette plongé dans la documentation a également attiré notre attention sur le fait que les headers pouvaient ou non être utilisé comme identifiant d'enregistrement. </p>
<p>Et c'est embêtant, car pour réaliser les appels à la vraie API, celle que nous enregistrons, nous avons besoins d'un <code class="language-text">token</code> <strong>secret</strong> passé dans la paramètre <code class="language-text">authorization</code> des en-têtes http ! Et effectivement, en regardant dans nos premiers fichiers d'enregistrements: horreur !</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"log"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    ...
    <span class="token property">"entries"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">"_id"</span><span class="token operator">:</span> <span class="token string">"6ae90598bd68b085105dc62620e42539"</span><span class="token punctuation">,</span>
        <span class="token property">"_order"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token property">"cache"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"request"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"bodySize"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
          <span class="token property">"cookies"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token property">"headers"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
              <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"accept"</span><span class="token punctuation">,</span>
              <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"application/json, text/plain, */*"</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
              <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"authorization"</span><span class="token punctuation">,</span>
              "value<span class="token string">": "</span>Bearer OURSUPERSUPERSECRETTOKEN"
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
          ...</code></pre></div>
<p>Et là où il faut être attentif, c'est qu'exlure les headers des identifiants d'enregistrement de Polly n'implique pas que les <code class="language-text">headers</code> ne se retrouvent pas dans les enregistrements. Pour vraiment les y exlure, il faut un peu mettre les mains sous le capot :</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// in router.spec.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createRequest <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./createRequest'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> describePolly<span class="token punctuation">,</span> setupPolly <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./setupPolly'</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Object API endpoint'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> polly<span class="token punctuation">:</span> <span class="token punctuation">{</span> server <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">setupPolly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'beforePersist'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> recording</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        recording<span class="token punctuation">.</span>request<span class="token punctuation">.</span>headers <span class="token operator">=</span> recording<span class="token punctuation">.</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> name <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> name <span class="token operator">!==</span> <span class="token string">'authorization'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">describe</span><span class="token punctuation">(</span><span class="token function">describePolly</span><span class="token punctuation">(</span><span class="token string">'GET /objectId'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should return an object from external API'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> request <span class="token operator">=</span> <span class="token function">createRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> request<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/uuid'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> status<span class="token punctuation">,</span> body <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                <span class="token function">expect</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">expect</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span>title<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token string">'real name from real api call'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Ainsi configuré, Polly permet maintenant d'enregistrer tous les appels http réalisés durant les tests, d'exclure les éventuels jetons secrets des enregistrements, et de rejouer de manière stable les enregistrements lors du passage des tests sur le serveur d'intégration continue.</p>
<h2>Second Piège</h2>
<p>Les tests sont stables. En fait trop stables ! Nous les avons mis en place avant d'entamer un refactoring conséquent sur notre projet suite à l'introduction de la nouvelle API. Et les tests sont restés vert durant tous cette phase de refactoring.</p>
<p>Incroyable ? Non, désastreux !</p>
<blockquote>
<p>Il ne faut jamais faire confiance à un test qui n'a jamais échoué !</p>
</blockquote>
<p>Et effectivement, nous avons fait une erreur, rétrospectivement idiote, lors de la mise en place de Polly. Le problème de port httpaurait dû nous alerter de suite ! </p>
<p><strong>Nous avons enregistré la réponse de l'API que nous voulions tester !</strong> Les tests étaient donc de fait très stable ...</p>
<p>Il faut donc remettre les mains sous le capot pour exclure les appels à localhost (notre serveur d'API) des enregistrements :</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// in router.spec.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createRequest <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./createRequest'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> describePolly<span class="token punctuation">,</span> setupPolly <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./setupPolly'</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Object API endpoint'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> polly<span class="token punctuation">:</span> <span class="token punctuation">{</span> server <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">setupPolly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'beforePersist'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> recording</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        recording<span class="token punctuation">.</span>request<span class="token punctuation">.</span>headers <span class="token operator">=</span> recording<span class="token punctuation">.</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> name <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> name <span class="token operator">!==</span> <span class="token string">'authorization'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    server
        <span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">req</span> <span class="token operator">=></span> <span class="token regex">/^127.0.0.1:[0-9]+$/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">passthrough</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">describe</span><span class="token punctuation">(</span><span class="token function">describePolly</span><span class="token punctuation">(</span><span class="token string">'GET /objectId'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should return an object from external API'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> request <span class="token operator">=</span> <span class="token function">createRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> request<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/uuid'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> status<span class="token punctuation">,</span> body <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                <span class="token function">expect</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">expect</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span>title<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token string">'real name from real api call'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<h2>Conclusion</h2>
<p>Polly.js est sans aucun doute une bonne librairie pour enregistrer et rejouer des appels d'API. La documentation est très propre, et elle est maintenue par un boite qui devrait durée.</p>
<p>Mais sa mise en place n'est pas sans chausses-trappes, et demande donc d'être bien attentif aux enregistrements réalisés, même si de part leur taille, leur review n'est pas évidente sur Github.</p>
<p>On aurait aimé que des problématiques aussi classique que l'exclusion de certaines url (particulièrement le localhost !) ou l'exclusion de certain en-têtes d'authentification puissent être plus simplement géré, par exemple depuis la configuration ! </p>
<p>Mais cela fait une bonne occasion de réaliser une PR sur le github du projet à durant ce mois d'HacktoberFest !</p></div><div class="just-comments" data-apikey="cdfe5295-0bb5-4662-b98b-11fcfc0eaa83"></div></div></div></header></div></div><script>
  
  function gaOptout(){document.cookie=disableStr+'=true; expires=Thu, 31 Dec 2099 23:59:59 UTC;path=/',window[disableStr]=!0}var gaProperty='UA-129388047-1',disableStr='ga-disable-'+gaProperty;document.cookie.indexOf(disableStr+'=true')>-1&&(window[disableStr]=!0);
  if(!(navigator.doNotTrack == "1" || window.doNotTrack == "1")) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-129388047-1', 'auto', {});
      ga('set', 'anonymizeIp', true);
      
      
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-blog-post-js","jsonName":"bouchonner-une-api-avec-pollyjs-c29","path":"/bouchonner-une-api-avec-pollyjs"};window.dataPath="891/path---bouchonner-une-api-avec-pollyjs-c-29-2f2-cExi8Ie1B86iaS2F28uDaRTI";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-6c5376e06f2d7e34c5c3.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-a3c7316724bb72f3a7bc.js"],"component---src-pages-about-js":["/component---src-pages-about-js-a155a3467ee0e3bf1d29.js"],"component---src-pages-index-js":["/component---src-pages-index-js-0392324a975bb04d2abd.js"],"pages-manifest":["/pages-manifest-a28b190b1a48d528bfca.js"]};/*]]>*/</script><script src="/component---src-templates-blog-post-js-a3c7316724bb72f3a7bc.js" async=""></script><script src="/2-0e0f7c0717f48b96baf5.js" async=""></script><script src="/1-2dea483b5ed5e468183a.js" async=""></script><script src="/styles-7d82cead6d54fb5cd7e1.js" async=""></script><script src="/app-6c5376e06f2d7e34c5c3.js" async=""></script><script src="/webpack-runtime-5c4d75ee9233b0c60d72.js" async=""></script></body></html>