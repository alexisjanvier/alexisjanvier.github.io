webpackJsonp([0x9cfc7f7f8dff],{411:function(n,s){n.exports={data:{markdownRemark:{html:'<p><img src="/images/code-splitting/splitting.jpg" alt="splitting.jpg"></p>\n<p>Nous travaillons actuellement chez Marmelab sur un projet client pour lequel nous avons progressivement migré depuis une application Symfony avec un peu de React côté client vers une application full React intégralement rendue côté serveur. Cette migration s’est faite petit à petit, en partant d’une stack familière incluant React Router V3, Redux et Saga. Mais les features s’enchainant, le code est devenu de plus en plus lourd et le routing s’est complexifié. À l’occasion de la trêve d’été sont donc apparus dans notre backlog les deux tickets suivant : « migration en React Router 4" et « mise en place du code splitting ».</p>\n<p>Si la migration du routeur s’annonçait un peu longue (voir <a href="">React Router v4 Unofficial Migration Guide</a>) mais possible, nous voulions avant d’entamer ces 2 taches valider avec un POC le fonctionnement d’une stack incluant React Router v4 (RRV4), Redux Saga, fournissant du code splitting et compatible avec du <em>server side rendering</em> (SSR). Ce post documente la réalisation de ce POC !</p>\n<h2>On repart de zero</h2>\n<p>L\'opération de migration de l\'application du client en RRV4 s\'annonçant un peu longue, il était plus simple dans le cadre du POC de reprendre une application de zéro, mais possédant les mêmes contraintes de routing que celles rencontrées dans l\'application <em>"mère"</em>.\nVous trouverez ici le code de cette application de départ (n\'incluant pas encore Redux et ne réalisant pas d\'appels asynchrones pour récupérer de la donnée) : <a href="https://github.com/alexisjanvier/universal-react/releases/tag/step-1">bootstrap de l\'application</a>.</p>\n<p>On va trouver quelques dépendances à des librairies externes :</p>\n<div class="gatsby-highlight">\n      <pre class="language-json"><code>// in package.json\n<span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n  <span class="token property">"date-fns"</span><span class="token operator">:</span> <span class="token string">"^1.28.5"</span><span class="token punctuation">,</span>\n  <span class="token property">"lodash.debounce"</span><span class="token operator">:</span> <span class="token string">"^4.0.8"</span><span class="token punctuation">,</span>\n  <span class="token property">"material-ui"</span><span class="token operator">:</span> <span class="token string">"^1.0.0-alpha.21"</span><span class="token punctuation">,</span>\n  <span class="token property">"material-ui-icons"</span><span class="token operator">:</span> <span class="token string">"^1.0.0-alpha.19"</span><span class="token punctuation">,</span>\n  <span class="token property">"prop-types"</span><span class="token operator">:</span> <span class="token string">"^15.5.10"</span><span class="token punctuation">,</span>\n  <span class="token property">"query-string"</span><span class="token operator">:</span> <span class="token string">"^4.3.4"</span><span class="token punctuation">,</span>\n  <span class="token property">"react"</span><span class="token operator">:</span> <span class="token string">"^15.6.1"</span><span class="token punctuation">,</span>\n  <span class="token property">"react-dom"</span><span class="token operator">:</span> <span class="token string">"^15.6.1"</span><span class="token punctuation">,</span>\n  <span class="token property">"react-router-dom"</span><span class="token operator">:</span> <span class="token string">"^4.1.1"</span><span class="token punctuation">,</span>\n  <span class="token property">"typeface-roboto"</span><span class="token operator">:</span> <span class="token string">"0.0.31"</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n</code></pre>\n      </div>\n<p>Et un routing simple en RRV4:</p>\n<div class="gatsby-highlight">\n      <pre class="language-js"><code><span class="token comment">// in src/shared/app/index.js</span>\n<span class="token operator">&lt;</span>Switch<span class="token operator">></span>\n  <span class="token operator">&lt;</span>Route exact path<span class="token operator">=</span><span class="token string">"/"</span> component<span class="token operator">=</span><span class="token punctuation">{</span>HomePage<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>\n  <span class="token operator">&lt;</span>Route path<span class="token operator">=</span><span class="token string">"/playlists/:playlistId(pl-[a-z]{0,4})"</span> component<span class="token operator">=</span><span class="token punctuation">{</span>PlaylistPage<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>\n  <span class="token operator">&lt;</span>Route path<span class="token operator">=</span><span class="token string">"/playlists"</span> component<span class="token operator">=</span><span class="token punctuation">{</span>PlayListsPage<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>\n  <span class="token operator">&lt;</span>Route path<span class="token operator">=</span><span class="token string">"/search-album"</span> component<span class="token operator">=</span><span class="token punctuation">{</span>SearchAlbumPage<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>\n  <span class="token operator">&lt;</span>Route path<span class="token operator">=</span><span class="token string">"/albums/:albumSlug"</span> component<span class="token operator">=</span><span class="token punctuation">{</span>AlbumPage<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>Switch<span class="token operator">></span>\n</code></pre>\n      </div>\n<h3>Visualiser le gain</h3>\n<p>L\'objectif de tout cela est bien d\'optimiser notre code en générant des fichiers Javascript plus petits.\nIl faut donc s\'outiller pour analyser les fichiers générés par Webpack et pour cela <a href="https://www.npmjs.com/package/webpack-bundle-analyzer">webpack-bundle-analyzer</a> s\'annonce comme un excellent candidat.</p>\n<p>Pour le moment Webpack ne génère qu\'un seul fichier pour toute l\'application:</p>\n<div class="gatsby-highlight">\n      <pre class="language-js"><code><span class="token comment">// in webpack.config.js</span>\n  entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    client<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>srcPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/client/index.js`</span></span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    path<span class="token punctuation">:</span> distPath<span class="token punctuation">,</span>\n    filename<span class="token punctuation">:</span> <span class="token string">\'[name].js\'</span><span class="token punctuation">,</span>\n    publicPath<span class="token punctuation">:</span> <span class="token string">\'/assets/\'</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n</code></pre>\n      </div>\n<p>Pour visualiser la composition de ce fichier avec <code>webpack-bundle-analyzer</code>, il suffit d\'ajouter le plugin à la configuration de webpack,</p>\n<div class="gatsby-highlight">\n      <pre class="language-js"><code><span class="token comment">// in webpack.config.js</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV  <span class="token operator">===</span>  <span class="token string">\'analyse\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BundleAnalyzerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre>\n      </div>\n<p>et de le lancer dans le bon environnement:</p>\n<div class="gatsby-highlight">\n      <pre class="language-bash"><code>    NODE_ENV<span class="token operator">=</span>analyse ./node_modules/.bin/webpack --config webpack.config.js -p\n</code></pre>\n      </div>\n<p>Le résultat: un gros fichier 274Kb (gzipped) dans lequel on trouve les nodes modules et notre code (la petite bande verticale à droite de l\'image!).</p>\n<p><img src="/images/code-splitting/startingApplicationBundle.png" alt="startingApplicationBundle.png">\nNous allons donc nous appliquer à découper ce fichier pour pouvoir n’appeler que le code dont on a besoin là ou l’on en a besoin. C’est le code splitting.</p>\n<h2>Première découpe</h2>\n<p>La première étape va consister à séparer dans 2 fichiers distincts (2 <strong><em>chunks</em></strong>) le code des nodes modules utilisé dans toute l\'application (<code>vendors.js</code>), et le code "métier" (<code>clients.js</code>).</p>\n<div class="gatsby-highlight">\n      <pre class="language-js"><code><span class="token comment">// in webpack.config.js</span>\nentry<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n  client<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>srcPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/client/index.js`</span></span><span class="token punctuation">,</span>\n  vendor<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'react\'</span><span class="token punctuation">,</span> <span class="token string">\'react-dom\'</span><span class="token punctuation">,</span> <span class="token string">\'react-router-dom\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\noutput<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n  path<span class="token punctuation">:</span> distPath<span class="token punctuation">,</span>\n  filename<span class="token punctuation">:</span> <span class="token string">\'[name].js\'</span><span class="token punctuation">,</span>\n  publicPath<span class="token punctuation">:</span> <span class="token string">\'/assets/\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n</code></pre>\n      </div>\n<p>Analysons ces maintenant 2 fichiers générés par Webpack:</p>\n<p><img src="/images/code-splitting/console1.png" alt="Capture d&#x27;écran de 2017-09-14 18-28-48.png"></p>\n<p><img src="/images/code-splitting/vendorChunkStep1.png" alt="vendorChunkStep1.png"></p>\n<p>On retrouve bien <code>react</code>, <code>react-dom</code> et <code>react-router-dom</code> dans le fichier <code>vendors.js</code>. Par contre, on les retrouve aussi dans <code>clients.js</code>. C\'est logique: Webpack a bien créé le <code>vendors.js</code> comme nous lui avons demandé, mais il a également créé le <code>client.js</code> incluant tous les <code>import</code>, <code>react</code> y compris. Nous avons donc presque doublé le poids du Javascript :(</p>\n<p>Pour y remédier, nous allons utiliser <a href="https://webpack.js.org/plugins/commons-chunk-plugin/">CommonsChunkPlugin</a> qui en gros va être capable de dédoublonner les modules spécifiés dans le <code>vendors.js</code> en ne les incluant plus dans <code>client.js</code>.</p>\n<p>Voici le configuration finale de Webpack :</p>\n<div class="gatsby-highlight">\n      <pre class="language-js"><code><span class="token comment">// in webpack.config.js</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> BundleAnalyzerPlugin <span class="token punctuation">}</span> <span class="token operator">=</span>  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpack-bundle-analyzer\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span>  path  <span class="token operator">=</span>  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span>  webpack  <span class="token operator">=</span>  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpack\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span>  srcPath  <span class="token operator">=</span>  path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'src\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span>  distPath  <span class="token operator">=</span>  path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'dist\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span>  plugins  <span class="token operator">=</span> <span class="token punctuation">[</span>\n  <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>optimize<span class="token punctuation">.</span>CommonsChunkPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'vendor\'</span><span class="token punctuation">,</span>\n    minChunks<span class="token punctuation">:</span> <span class="token number">Infinity</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV  <span class="token operator">===</span>  <span class="token string">\'analyse\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BundleAnalyzerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  context<span class="token punctuation">:</span> srcPath<span class="token punctuation">,</span>\n  target<span class="token punctuation">:</span> <span class="token string">\'web\'</span><span class="token punctuation">,</span>\n\n  entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    client<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>srcPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/client/index.js`</span></span><span class="token punctuation">,</span>\n    vendor<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'react\'</span><span class="token punctuation">,</span> <span class="token string">\'react-dom\'</span><span class="token punctuation">,</span> <span class="token string">\'react-router-dom\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    path<span class="token punctuation">:</span> distPath<span class="token punctuation">,</span>\n    filename<span class="token punctuation">:</span> <span class="token string">\'[name].js\'</span><span class="token punctuation">,</span>\n    publicPath<span class="token punctuation">:</span> <span class="token string">\'/assets/\'</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n  resolve<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    modules<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'node_modules\'</span><span class="token punctuation">,</span> <span class="token string">\'src\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    extensions<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'*\'</span><span class="token punctuation">,</span> <span class="token string">\'.js\'</span><span class="token punctuation">,</span> <span class="token string">\'.json\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n      <span class="token punctuation">{</span>\n        test<span class="token punctuation">:</span>  <span class="token regex">/\\.js$/</span><span class="token punctuation">,</span>\n        exclude<span class="token punctuation">:</span>  <span class="token regex">/(node_modules)/</span><span class="token punctuation">,</span>\n        loader<span class="token punctuation">:</span> <span class="token string">\'babel-loader\'</span><span class="token punctuation">,</span>\n        query<span class="token punctuation">:</span> <span class="token punctuation">{</span> compact<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n  plugins<span class="token punctuation">,</span>\n  devtool<span class="token punctuation">:</span> <span class="token string">\'source-map\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n</code></pre>\n      </div>\n<p>Et le résultat final :</p>\n<p><img src="/images/code-splitting/vendorChunkStep2.png" alt="vendorChunkStep2.png"></p>\n<p><img src="/images/code-splitting/vendorChunkStep3.png" alt="vendorChunkStep3.png">\nC\'est déjà beaucoup mieux. <code>CommonsChunkPlugin</code> fait encore beaucoup de choses permettant d\'optimiser son code. Je vous renvoie à la lecture de <a href="https://medium.com/webpack/webpack-bits-getting-the-most-out-of-the-commonschunkplugin-ab389e5f318">webpack bits: Getting the most out of the CommonsChunkPlugin</a> si vous voulez approfondir le sujet.</p>\n<p>(<em>Le code de cette étape est disponible sur le tag <a href="https://github.com/alexisjanvier/universal-react/releases/tag/step-2">step-2</a></em>)</p>\n<p>Il faut maintenant s\'occuper de la découpe du <code>client.js</code>. Mais avant cela, nous allons mettre en place le SSR de notre application.</p>\n<h2>Mise en place du server side rendering</h2>\n<p>Ici, rien de très compliqué, l\'un des avantages de React étant d\'avoir le SSR "out of the box". Ceci grâce à la méthode <code>renderToString</code> permettant de rendre notre application React dans un string avec Node.</p>\n<p>Ce qui nous intéresse dans le cadre du POC, c\'est le comportement du React Router. Tout repose sur l\'utilisation d\'un routeur spécifique, le <a href="https://reacttraining.com/web/api/StaticRouter"><code>&#x3C;StaticRouter></code></a> que l\'on utilisera à la place du <a href="https://reacttraining.com/web/api/BrowserRouter"><code>&#x3C;BrowserRouter></code></a></p>\n<p>![Capture d\'écran de 2017-09-15 09-10-43.png](/images/code-splitting/Capture d\'écran de 2017-09-15 09-10-43.png)\nOn organise le code dans trois dossiers distincts.</p>\n<h4>Le code commun (shared)</h4>\n<p>C\'est ici que l\'on trouve toute notre application, avec la mise en place des routes.</p>\n<div class="gatsby-highlight">\n      <pre class="language-js"><code><span class="token comment">// in src/shared/app/index.js</span>\n<span class="token keyword">const</span> <span class="token function-variable function">App</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>\n  <span class="token operator">&lt;</span>div<span class="token operator">></span>\n    <span class="token operator">&lt;</span>MainMenu <span class="token operator">/</span><span class="token operator">></span>\n    <span class="token operator">&lt;</span>Switch<span class="token operator">></span>\n      <span class="token operator">&lt;</span>Route  exact  path<span class="token operator">=</span><span class="token string">"/"</span>  component<span class="token operator">=</span><span class="token punctuation">{</span>HomePage<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>\n      <span class="token operator">&lt;</span>Route  path<span class="token operator">=</span><span class="token string">"/playlists/:playlistId(pl-[a-z]{0,4})"</span>  component<span class="token operator">=</span><span class="token punctuation">{</span>PlaylistPage<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>\n      <span class="token operator">&lt;</span>Route  path<span class="token operator">=</span><span class="token string">"/playlists"</span>  component<span class="token operator">=</span><span class="token punctuation">{</span>PlayListsPage<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>\n      <span class="token operator">&lt;</span>Route  path<span class="token operator">=</span><span class="token string">"/search-album"</span>  component<span class="token operator">=</span><span class="token punctuation">{</span>SearchAlbumPage<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>\n      <span class="token operator">&lt;</span>Route  path<span class="token operator">=</span><span class="token string">"/albums/:albumSlug"</span>  component<span class="token operator">=</span><span class="token punctuation">{</span>AlbumPage<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>\n    <span class="token operator">&lt;</span><span class="token operator">/</span>Switch<span class="token operator">></span>\n  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre>\n      </div>\n<h4>Le code navigateur (client)</h4>\n<p>C\'est ici que l\'on assure le rendu côté navigateur. Il s\'agit pour le moment d\'appeler notre application dans le routeur dédié aux navigateurs.</p>\n<div class="gatsby-highlight">\n      <pre class="language-js"><code><span class="token comment">// in src/client/index.js</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> render <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-dom\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> BrowserRouter <span class="token keyword">as</span> Router <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-router-dom\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">\'../shared/app\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>\n    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span>\n            <span class="token operator">&lt;</span>Router<span class="token operator">></span>\n                <span class="token operator">&lt;</span>App <span class="token punctuation">{</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>\n            <span class="token operator">&lt;</span><span class="token operator">/</span>Router<span class="token operator">></span>\n        <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n      </div>\n<h4>Le code serveur (server)</h4>\n<p>C\'est un serveur <code>express</code> dont une route servira à générer le code html de l\'application au sein du router <code>&#x3C;StaticRouter></code>. Cette string sera injectée dans un template html afin de générer la réponse finale du serveur. Le client utilisera alors le code client présent dans cette réponse pour redevenir une application React classique.</p>\n<div class="gatsby-highlight">\n      <pre class="language-js"><code><span class="token comment">// in src/server/index.js</span>\n<span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">\'express\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> ReactDOMServer <span class="token keyword">from</span> <span class="token string">\'react-dom/server\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> StaticRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-router-dom\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">\'../shared/app\'</span><span class="token punctuation">;</span>\n<span class="token comment">// render is used to inject html in a globale template</span>\n<span class="token keyword">import</span> render <span class="token keyword">from</span> <span class="token string">\'./render\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// Serve client.js and vendor.js</span>\napp<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">\'/assets\'</span><span class="token punctuation">,</span> express<span class="token punctuation">.</span><span class="token keyword">static</span><span class="token punctuation">(</span><span class="token string">\'./dist\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\napp<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">\'*\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> appWithRouter <span class="token operator">=</span> <span class="token punctuation">(</span>\n        <span class="token operator">&lt;</span>StaticRouter location<span class="token operator">=</span><span class="token punctuation">{</span>req<span class="token punctuation">.</span>url<span class="token punctuation">}</span> context<span class="token operator">=</span><span class="token punctuation">{</span>context<span class="token punctuation">}</span><span class="token operator">></span>\n            <span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">></span>\n        <span class="token operator">&lt;</span><span class="token operator">/</span>StaticRouter<span class="token operator">></span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">const</span> html <span class="token operator">=</span> ReactDOMServer<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span>appWithRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token function">render</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\napp<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'Demo app listening on port 3000\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre>\n      </div>\n<p>Et tout cela marche plutôt bien. Le manière la plus simple de le tester, c\'est de désactiver le javascript sur son navigateur.</p>\n<p><img src="/images/code-splitting/testSSR.gif" alt="testSSR.gif"></p>\n<p>(<em>Le code de cette étape est disponible sur le tag <a href="https://github.com/alexisjanvier/universal-react/releases/tag/step-3">step-3</a></em>)</p>\n<h2>Code splitting, phase 2</h2>\n<p>Et encore une fois, c\'est par webpack que cela passe. Si l\'on se réfère à la <a href="https://webpack.js.org/guides/code-splitting/">documentation</a>, le code splitting repose sur 3 approches :</p>\n<blockquote>\n<ul>\n<li>Entry Points: Manually split code using <a href="https://webpack.js.org/configuration/entry-context"><code>entry</code></a> configuration.</li>\n<li>Prevent Duplication: Use the <a href="https://webpack.js.org/plugins/commons-chunk-plugin"><code>CommonsChunkPlugin</code></a> to dedupe and split chunks.</li>\n<li>Dynamic Imports: Split code via inline function calls within modules.</li>\n</ul>\n</blockquote>\n<p>Bonne nouvelle, nous avons déjà appliqué les deux premières approches. Reste donc l\'approche de l\'import dynamique. En gros, le code appelé de manière dynamique (asynchrone) sera isolé dans un chunk par Webpack qui se chargera également de générer le code permettant d\'appeler le bon chunk au bon moment.</p>\n<p>Pour appeller du code de manière dynamique et reconnu par webpack, on va devoir utiliser la syntaxe <a href="https://webpack.js.org/api/module-methods#import-"><code>import()</code></a> (methode recommandée car conforme à l\'ECMAScript) ou bien la syntaxe <a href="https://webpack.js.org/api/module-methods#require-ensure"><code>require.ensure</code></a> spécifique à WebPack.</p>\n<p>Ce qui donnerait pour un composant React</p>\n<div class="gatsby-highlight">\n      <pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span>\n\n<span class="token keyword">class</span> <span class="token class-name">Home</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>\n  state <span class="token operator">=</span> <span class="token punctuation">{</span> Component<span class="token punctuation">:</span> <span class="token keyword">null</span> <span class="token punctuation">}</span>\n\n  <span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">\'./Home\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>Component <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> Component <span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state\n    <span class="token keyword">return</span> Component <span class="token operator">?</span> <span class="token operator">&lt;</span>Component <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span> <span class="token punctuation">:</span> <span class="token keyword">null</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n      </div>\n<p><em>(cet exemple provient du post de blog <a href="https://medium.com/smooth-code/introducing-loadable-components-%EF%B8%8F-646dd3ab0aa6">Introducing loadable-components</a>)</em></p>\n<p>Afin de ne pas avoir à transformer tous nos composants on va utiliser un <a href="https://facebook.github.io/react/docs/higher-order-components.html">HOC</a>, le <a href="https://www.npmjs.com/package/loadable-components">loadable-components</a>.</p>\n<p>Ainsi, nous n\'appellerons plus nos composants de page de manière synchrone dans le routing, mais de manière asynchrone en les mappant dans ce HOC. Ainsi Webpack pourra créer un chunk par route.</p>\n<p>Notre <code>src/shared/app/index.js</code> ne vas pas changer.</p>\n<div class="gatsby-highlight">\n      <pre class="language-js"><code><span class="token comment">// in src/shared/app/index.js</span>\n<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> Route<span class="token punctuation">,</span> Switch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-router-dom\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> Routes <span class="token keyword">from</span> <span class="token string">\'./routes\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> MainMenu <span class="token keyword">from</span> <span class="token string">\'./mainMenu\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">App</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>\n    <span class="token operator">&lt;</span>div<span class="token operator">></span>\n        <span class="token operator">&lt;</span>MainMenu <span class="token operator">/</span><span class="token operator">></span>\n        <span class="token operator">&lt;</span>Switch<span class="token operator">></span>\n            <span class="token operator">&lt;</span>Route exact path<span class="token operator">=</span><span class="token string">"/"</span> component<span class="token operator">=</span><span class="token punctuation">{</span>Routes<span class="token punctuation">.</span>HomePage<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>\n            <span class="token operator">&lt;</span>Route path<span class="token operator">=</span><span class="token string">"/playlists/:playlistId(pl-[a-z]{0,4})"</span> component<span class="token operator">=</span><span class="token punctuation">{</span>Routes<span class="token punctuation">.</span>PlaylistPage<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>\n            <span class="token operator">&lt;</span>Route path<span class="token operator">=</span><span class="token string">"/playlists"</span> component<span class="token operator">=</span><span class="token punctuation">{</span>Routes<span class="token punctuation">.</span>PlayListsPage<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>\n            <span class="token operator">&lt;</span>Route path<span class="token operator">=</span><span class="token string">"/search-album"</span> component<span class="token operator">=</span><span class="token punctuation">{</span>Routes<span class="token punctuation">.</span>SearchAlbumPage<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>\n            <span class="token operator">&lt;</span>Route path<span class="token operator">=</span><span class="token string">"/albums/:albumSlug"</span> component<span class="token operator">=</span><span class="token punctuation">{</span>Routes<span class="token punctuation">.</span>AlbumPage<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>\n        <span class="token operator">&lt;</span><span class="token operator">/</span>Switch<span class="token operator">></span>\n    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> App<span class="token punctuation">;</span>\n</code></pre>\n      </div>\n<p>Mais tout se passse au niveu de <code>src/shared/app/routes.js</code>:</p>\n<div class="gatsby-highlight">\n      <pre class="language-js"><code><span class="token comment">// src/shared/app/routes.js</span>\n<span class="token keyword">import</span> loadable <span class="token keyword">from</span> <span class="token string">\'loadable-components\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">const</span> AlbumPage <span class="token operator">=</span> <span class="token function">loadable</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">\'../albums/AlbumPage\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> HomePage <span class="token operator">=</span> <span class="token function">loadable</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">\'../home/HomePage\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> PlaylistPage <span class="token operator">=</span> <span class="token function">loadable</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">\'../playlists/PlaylistPage\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> PlayListsPage <span class="token operator">=</span> <span class="token function">loadable</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">\'../playlists/ListPage\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> SearchAlbumPage <span class="token operator">=</span> <span class="token function">loadable</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">\'../albums/SearchPage\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre>\n      </div>\n<p>Il faut également penser à rendre Babel compatible avec la syntaxe <code>import()</code> en ajoutant le plugin <a href="https://github.com/airbnb/babel-plugin-dynamic-import-webpack">dynamic-import-webpack</a></p>\n<div class="gatsby-highlight">\n      <pre class="language-json"><code>// in .babelrc\n<span class="token punctuation">{</span>\n    <span class="token property">"plugins"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"dynamic-import-webpack"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    <span class="token property">"presets"</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n        <span class="token string">"react"</span><span class="token punctuation">,</span>\n        <span class="token punctuation">[</span>\n            <span class="token string">"env"</span><span class="token punctuation">,</span>\n            <span class="token punctuation">{</span>\n                <span class="token property">"targets"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n                    <span class="token property">"browsers"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"last 1 version"</span><span class="token punctuation">,</span> <span class="token string">"ie >= 11"</span><span class="token punctuation">]</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">]</span>\n    <span class="token punctuation">]</span>\n<span class="token punctuation">}</span>\n</code></pre>\n      </div>\n<p>Et il est maintenant temps de voir le résultat final :</p>\n<div class="gatsby-highlight">\n      <pre class="language-bash"><code>NODE_ENV<span class="token operator">=</span>analyse ./node_modules/.bin/webpack --config webpack.client.config.js -p\nHash: 6ab25e3738d87ca6f2d5\nVersion: webpack 3.3.0\nTime: 5715ms\n     Asset       Size  Chunks             Chunk Names\n      0.js    36.5 kB       0  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>\n      1.js    36.9 kB       1  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>\n      2.js    11.6 kB       2  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>\n      3.js    20.7 kB       3  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>\n      4.js  747 bytes       4  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>\n client.js     102 kB       5  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  client\n vendor.js     191 kB       6  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  vendor\nindex.html  409 bytes          <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>\n</code></pre>\n      </div>\n<p><img src="/images/code-splitting/vendorChunkWithCodeSpliting.png" alt="vendorChunkWithCodeSpliting.png">\nEt voilà, notre code est divisé en autant de chunks que de pages, plus un <code>client.js</code> et un <code>vendor.js</code> utilisés par toutes les pages de l\'application !</p>\n<p><img src="/images/code-splitting/codeSplitting.gif" alt="codeSplitting.gif"></p>\n<p>(<em>Le code de cette étape est disponible sur le tag <a href="https://github.com/alexisjanvier/universal-react/releases/tag/step-4">step-4</a></em>)</p>\n<p>Mais est-ce que cela marche avec le SSR ?</p>\n<p><img src="/images/code-splitting/CS-SSR-KO.gif" alt="CS-SSR-KO.gif"></p>\n<p>Eh bien non, pas encore :(</p>\n<p>Cela s\'explique assez bien: le code de nos composants de pages est maintenant appelé de manière asynchrone. Or, la route côté serveur est elle synchrone. On retrouve donc bien tout le code appelé de manière classique (la barre de menu), mais pas le contenu des pages.</p>\n<p>Pour que cela fonctionne, on va utiliser la méthode <code>getLoadableState</code> fournie par <code>loadable-components</code> qui va nous permettre de réaliser un pré rendu de l\'application côté serveur (dont les appels asynchrones) et d\'extraire les références des chunks nécessaires au rendu de la page demandée. Nous allons aussi devoir rendre la route de rendu asynchrone (avec <code>async</code> et <code>await</code>).</p>\n<div class="gatsby-highlight">\n      <pre class="language-js"><code><span class="token comment">// in src/server/index.js</span>\n<span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">\'express\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> ReactDOMServer <span class="token keyword">from</span> <span class="token string">\'react-dom/server\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> StaticRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-router-dom\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> getLoadableState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'loadable-components/server\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">\'../shared/app\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> render <span class="token keyword">from</span> <span class="token string">\'./render\'</span><span class="token punctuation">;</span>\n\n\n<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\napp<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">\'/assets\'</span><span class="token punctuation">,</span> express<span class="token punctuation">.</span><span class="token keyword">static</span><span class="token punctuation">(</span><span class="token string">\'./dist\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\napp<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">\'*\'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> appWithRouter <span class="token operator">=</span> <span class="token punctuation">(</span>\n        <span class="token operator">&lt;</span>StaticRouter location<span class="token operator">=</span><span class="token punctuation">{</span>req<span class="token punctuation">.</span>url<span class="token punctuation">}</span> context<span class="token operator">=</span><span class="token punctuation">{</span>context<span class="token punctuation">}</span><span class="token operator">></span>\n            <span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">></span>\n        <span class="token operator">&lt;</span><span class="token operator">/</span>StaticRouter<span class="token operator">></span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">const</span> loadableState <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getLoadableState</span><span class="token punctuation">(</span>appWithRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> html <span class="token operator">=</span> ReactDOMServer<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span>appWithRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token function">render</span><span class="token punctuation">(</span>html<span class="token punctuation">,</span> loadableState<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\napp<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'Demo app listening on port 3000\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre>\n      </div>\n<p>Les références aux chunks utilés sont injectées dans le template global de la page via la méthode <code>getScriptTag()</code> de l\'objet <code>loadableState</code> généré lors de pré-rendu:</p>\n<div class="gatsby-highlight">\n      <pre class="language-js"><code><span class="token comment">// in src/server/render.js</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span>html<span class="token punctuation">,</span> loadableState<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token template-string"><span class="token string">`\n    &lt;!DOCTYPE html>\n    &lt;html lang="en">\n        &lt;head>\n            &lt;meta charset="UTF-8">\n            &lt;title>Get real playlists to share with Spotify&lt;/title>\n            &lt;link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">\n            &lt;link rel="icon" type="image/png" href="/assets/favicon.ico" />\n        &lt;/head>\n        &lt;body>\n            &lt;div id="root"></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>html<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/div>\n            &lt;script src="/assets/vendor.js">&lt;/script>\n            &lt;script src="/assets/client.js">&lt;/script>\n            </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>loadableState<span class="token punctuation">.</span><span class="token function">getScriptTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n        &lt;/body>\n    &lt;/html>\n`</span></span><span class="token punctuation">;</span>\n</code></pre>\n      </div>\n<p><code>loadableState.getScriptTag()</code> va permettre d\'inserer la balise <code>&#x3C;script>window.__LOADABLE_COMPONENT_IDS__ = [1];&#x3C;/script></code> (ici le <code>[1]</code>) correspond au numéro du chunk de la homepage). Au final, le code client va utiliser cette information pour charger le bon chunk grâce à l\'utilisation de la méthode <code>loadComponents</code> fournie par le <code>loadable-components</code>.</p>\n<div class="gatsby-highlight">\n      <pre class="language-js"><code><span class="token comment">// in src/client/index.js</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> loadComponents <span class="token punctuation">}</span> <span class="token keyword">from</span>  <span class="token string">\'loadable-components\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> render <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-dom\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> BrowserRouter <span class="token keyword">as</span> Router <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-router-dom\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">\'../shared/app\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">Main</span> <span class="token operator">=</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>\n    <span class="token operator">&lt;</span>Router<span class="token operator">></span>\n        <span class="token operator">&lt;</span>App <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>\n    <span class="token operator">&lt;</span><span class="token operator">/</span>Router<span class="token operator">></span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token function">loadComponents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token function">render</span><span class="token punctuation">(</span>\n        <span class="token operator">&lt;</span>Main <span class="token operator">/</span><span class="token operator">></span>\n        document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">\'root\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre>\n      </div>\n<p>Re-testons après avoir appliquer ces modifications (<em>diponibles sur le tag <a href="https://github.com/alexisjanvier/universal-react/releases/tag/step-5">step-5</a></em>)</p>\n<p><img src="/images/code-splitting/CS-SSR-OK.gif" alt="CS-SSR-OK.gif"></p>\n<p><strong>\\o/</strong></p>\n<h2>Implémentation de Redux et de Redux Saga</h2>\n<p>L\'ajout de Redux n\'est pas problématique vis-à-vis du Reactr Router V4 ni du code splitting. Par contre l\'utilisation de Saga n\'a pas été sans difficulté, principalement pour le server-side rendering.</p>\n<p>On va réaliser un simple appel à l\'API Github permettant d\'obtenir une liste des derniers Gist public (cet appel API ne nécessite pas de clé personnelle, rendant le partage du code de ce POC plus simple). L\'appel est fait via une saga depuis la home page. Toute la difficulté est d\'attendre que la saga soit réalisée côté serveur avant de rendre le Html. On y arrive principalement avec :</p>\n<ul>\n<li>un premier prérendu asynchrone qui va lancer les sagas (c\'est ce que nous faisons déjà avec le <code>const loadableState = await getLoadableState(appWithRouter)</code> mis en place pour rendre le code splitting fonctionnel en SSR),</li>\n<li>l\'utilisation de l\'évènement <a href="https://github.com/redux-saga/redux-saga/issues/255"><code>END</code></a> qui permet de résoudre toutes les sagas en écoute.</li>\n</ul>\n<p>Je ne vais pas détailler ce point, car cela a déjà été fait par mon cher collègue <a href="https://twitter.com/juliendemangeon?lang=fr">Julien</a> dans son post de blog <a href="https://marmelab.com/blog/2016/12/21/react-isomorphique-en-pratique.html">React Isomorphique en pratique</a>.</p>\n<p>Mais voici à quoi ressemble le code final côté serveur :</p>\n<div class="gatsby-highlight">\n      <pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">\'*\'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">configureStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> appWithRouter <span class="token operator">=</span> <span class="token punctuation">(</span>\n        <span class="token operator">&lt;</span>Provider store<span class="token operator">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span><span class="token operator">></span>\n            <span class="token operator">&lt;</span>StaticRouter location<span class="token operator">=</span><span class="token punctuation">{</span>req<span class="token punctuation">.</span>url<span class="token punctuation">}</span> context<span class="token operator">=</span><span class="token punctuation">{</span>context<span class="token punctuation">}</span><span class="token operator">></span>\n                <span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">></span>\n            <span class="token operator">&lt;</span><span class="token operator">/</span>StaticRouter<span class="token operator">></span>\n        <span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">></span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">let</span> loadableState <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// .done is resolved when store.close() send an END event</span>\n    store<span class="token punctuation">.</span><span class="token function">runSaga</span><span class="token punctuation">(</span>sagas<span class="token punctuation">)</span><span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> html <span class="token operator">=</span> ReactDOMServer<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span>appWithRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">const</span> preloadedState <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token function">render</span><span class="token punctuation">(</span>html<span class="token punctuation">,</span> loadableState<span class="token punctuation">,</span> preloadedState<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// Trigger sagas for component to run</span>\n    <span class="token comment">// https://github.com/yelouafi/redux-saga/issues/255#issuecomment-210275959</span>\n    loadableState <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getLoadableState</span><span class="token punctuation">(</span>appWithRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// Dispatch a close event so sagas stop listening after they\'re resolved</span>\n    store<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre>\n      </div>\n<p>Le code complet est disponible sur le <a href="https://github.com/alexisjanvier/universal-react">master</a> du dépot Github.</p>\n<h2>Conclusion</h2>\n<p>L\'objectif du POC est bien atteint : on a une application React, React Router V4, Redux, Saga qui fonctionne. Le code est bien découpé en plusieurs fichiers distincts et ces parties de code ne sont appelées qu\'en cas de besoin (en fonction du routing). L\'ensemble fonctionne en server side rendering.</p>\n<p>Pour autant quelques réserves persistent. Le choix important du composant HOC permettant d\'appeler des composants existants en asynchrone c\'est fait sur la facilité. <code>loadable-components</code> répondant au cahier des charges. Mais il en existe beaucoup d\'autres : # <a href="https://github.com/faceyspacey/react-universal-component">react-universal-component</a>, <a href="https://github.com/thejameskyle/react-loadable">react-loadable</a>... Il faudrait tous les tester en condition de production pour être serein sur ce choix.</p>\n<p>Ensuite, le server side rendering est une stratégie évidente dans le cadre de problématiques de SEO. Mais en ce qui concerne la performance, l\'arrivée du <a href="https://www.youtube.com/watch?v=UhdGiVy3_Nk">stream</a> dans la dernière version de React donne envie de poursuivre l\'expérimentation plus en amont avant d\'entamer un gros chantier d\'optimisation.</p>\n<p>Mais quand il s\'agit d\'optimisation, les pistes à suivre sont innombrables: web workers, lazyloading, pure component, preact ... Je vous invite par exemple à lire l\'excellent article <a href="https://medium.com/dev-channel/treebo-a-react-and-preact-progressive-web-app-performance-case-study-5e4f450d5299">A React And Preact Progressive Web App Performance Case Study: Treebo</a>.</p>',
frontmatter:{title:"React Router v4, SSR, Redux Saga et Code Splitting sont dans un bateau",date:"2017-10-22",tags:["React Router","SSR","Code Splitting","Redux","Saga"],description:"React est rapide, pour peu que l'on y applique les bonnes optimisations. Le code splitting et le server side rendering sont deux pistes permettant d'atteindre cet objectif. Utilisons-les toutes les deux sur une application s'appuyant sur Redux, Saga et React Router V4."}}},pathContext:{slug:"rr4-ssr-redux-code-splitting-dans-un-bateau"}}}});
//# sourceMappingURL=path---rr-4-ssr-redux-code-splitting-dans-un-bateau-2e2450c5c347d06b65e7.js.map