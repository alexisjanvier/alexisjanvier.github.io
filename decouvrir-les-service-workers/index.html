<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/component---src-templates-blog-post-js.f085196d2de1a81b1688.css">header h3,header h5{display:inline-block;margin-top:0;padding-right:.5rem}header a{background-image:none;text-decoration:none;text-shadow:none;vertical-align:middle}header a:hover{color:red}header a img{vertical-align:middle}.blog-list a:hover{color:#000}.blog-list h2,.blog-list h4{margin-bottom:.5rem}.blog-list h4{font-style:italic;margin-top:0}.blog-list h4 span{color:grey;display:inline-block;font-size:.8rem}.postIntro h1{font-size:2.5rem;margin-bottom:.5rem;margin-top:1rem;text-align:center;width:100%}.postIntro p.tags{color:grey;font-size:.8rem;margin:0;text-align:center}.postIntro p.date{margin:0 0 1rem;text-align:center}.postIntro p.intro{font-style:italic;margin-top:1.5rem}

/*# sourceMappingURL=component---src-templates-blog-post-js.f085196d2de1a81b1688.css.map*/</style><style data-href="/0.3fd366b1553ccbf40a17.css">code[class*=language-],pre[class*=language-]{-moz-hyphens:none;-moz-tab-size:4;-ms-hyphens:none;-o-tab-size:4;-webkit-hyphens:none;background:none;color:#ccc;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;hyphens:none;line-height:1.5;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal;word-wrap:normal}pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}

/*# sourceMappingURL=0.3fd366b1553ccbf40a17.css.map*/</style><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:125%/1.5 'PT Sans',sans-serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.8);font-family:'PT Sans',sans-serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;color:hsla(0,0%,0%,0.9);font-family:'Oswald',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:2rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;color:hsla(0,0%,0%,0.9);font-family:'Oswald',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1.51572rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;color:hsla(0,0%,0%,0.9);font-family:'Oswald',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1.31951rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;color:hsla(0,0%,0%,0.9);font-family:'Oswald',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;color:hsla(0,0%,0%,0.9);font-family:'Oswald',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:0.87055rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;color:hsla(0,0%,0%,0.9);font-family:'Oswald',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:0.81225rem;line-height:1.1;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}ul{margin-left:1.5rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;list-style-position:outside;list-style-image:none;}ol{margin-left:1.5rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;font-size:0.85rem;line-height:1.5rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;font-size:1rem;line-height:1.5rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}blockquote{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0.9375rem;padding-right:0;padding-top:0;margin-bottom:1.5rem;font-size:1.1487rem;line-height:1.5rem;border-left:0.5625rem solid #292d35;color:hsla(0,0%,0%,0.65);font-style:italic;}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.5rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.5rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.5rem;margin-bottom:calc(1.5rem / 2);margin-top:calc(1.5rem / 2);}li > ul{margin-left:1.5rem;margin-bottom:calc(1.5rem / 2);margin-top:calc(1.5rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.5rem / 2);}code{font-size:0.85rem;line-height:1.5rem;}kbd{font-size:0.85rem;line-height:1.5rem;}samp{font-size:0.85rem;line-height:1.5rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1rem;padding-right:1rem;padding-top:0.75rem;padding-bottom:calc(0.75rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}a{color:#292d35;text-decoration:none;text-shadow:.03em 0 #fff,-.03em 0 #fff,0 .03em #fff,0 -.03em #fff,.06em 0 #fff,-.06em 0 #fff,.09em 0 #fff,-.09em 0 #fff,.12em 0 #fff,-.12em 0 #fff,.15em 0 #fff,-.15em 0 #fff;background-image:linear-gradient(to top, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0) 1px, #292d35 1px, #292d35 2px, rgba(0, 0, 0, 0) 2px);}a:hover,a:active{text-shadow:none;background-image:none;}h1,h2,h3,h4,h5,h6{margin-top:3rem;}blockquote > :last-child{margin-bottom:0;}blockquote cite{font-size:1rem;line-height:1.5rem;color:hsla(0,0%,0%,0.8);font-style:normal;font-weight:400;}blockquote cite:before{content:"— ";}@media only screen and (max-width:480px){html{font-size:106.25%;line-height:1.45;}blockquote{border-left:0.28125rem solid #292d35;color:hsla(0,0%,0%,0.59);padding-left:0.84375rem;font-style:italic;margin-left:-1.125rem;margin-right:0;}}</style><link href="//fonts.googleapis.com/css?family=Oswald:700|PT+Sans:400,400i,700" rel="stylesheet" type="text/css"/><title data-react-helmet="true">Découvrir les service workers</title><meta data-react-helmet="true" name="author" content="Àlexis Janvier"/><meta data-react-helmet="true" name="description" content="Un outil de plus dans la panoplie des développeurs web ? Les services workers offrent bien plus que la simple possibilité de rendre une application disponible hors-ligne. Voyons ça en pratique."/><meta data-react-helmet="true" name="keywords" content="js,tutorial"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-4c703bcb2bfaced24bd4.js"/><link as="script" rel="preload" href="/app-607e8de0d9b68e3b2976.js"/><link as="script" rel="preload" href="/1-175a282ba0c8b68cf24f.js"/><link as="script" rel="preload" href="/0-a2cc8ebe3fc1c85def50.js"/><link as="script" rel="preload" href="/webpack-runtime-42bff34e6b7c3da03b9b.js"/><link rel="preload" href="/static/d/116/path---decouvrir-les-service-workers-38-a-c2f-zQrmxJlwkmlQoiWdzCiPpDf6s.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><header><div style="margin:0 auto;max-width:1000px;padding:1.25rem 1rem"><header style="margin-bottom:1.5rem"><a href="/"><h3>This is not &#x27;Nam.</h3><h5>This is my blog. There are rules.</h5></a><ul style="list-style:none;float:right"><li style="display:inline-block;margin-right:1rem"><a href="/">Blog</a></li><li style="display:inline-block;margin-right:1rem"><a href="/about/">About</a></li><li style="display:inline-block;margin-right:1rem"><a href="https://twitter.com/alexisjanvier"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAQAAADZc7J/AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAAmJLR0QA/4ePzL8AAAAJcEhZcwAAAjcAAAI3AfcGRMIAAAAHdElNRQfhCQEKGCQX757NAAACjElEQVRIx62VX0hTURzHP/e6NRkYLREcrLeCfFDBGL4UiWGJL+sP9FLkQ4FR7MGHhHTe251OqRBJX6qXIBDCelCQIAYS9CSVBCsHFT3EaIIxs8HYmnp72N28/zYn+Hs653fO93Pv7/x+5/wEFatNu9Y71QBNePECSZLEhXnPYjBn3SuYAWPevMQV6my4aWac4cFkBYBSS4h+3JS3DJOMyllbgNLIHO3sbkucl1ctgJHm7df4qpADJMSe4ZgBoDTyvmo5QAJ/4S9ELfa5PcnBx5xSWwIQqhj7Jo+Fy5wRBvgBQIy/QDshLYQxb/67dvKPOEWbSZ7inPyhMHxQl72lRnHzrpAR59HBpAh5qZS4Wbr4aALcLsphIC3d5w+XeAOAOy+BMOVKrZXK5oicmHalJAZwaJ4N2YOp1sIB9ZW2nj7cIK536qruJARz8pDYxlM2APhslo+cUGdL+Lr1TlEN6FZ7X9YADMfkPhqFs/SzYD7RbT8HdmZqwEGTbjUWv8GTwlDOEiVqk5MWw6zJgVc3fSEt71oBrYaZVzQAru8qF2g2A/TWp1ysrB89br7oIvr7XcNzZWK8oTxgK2JyJI0AyPDw7lo5udLNBSsgbnA08AzBXj7tYsrijIvCvMnVrSyH7yg2dzM1yDHLmc6LnkXSJm+r2oJo3qqEkCzMtGfREcwpM9wE4Be/WeELC/In477x+n8T9NpENRPMOcAZzl/DDRxklkn5p+nLh7jKPept5BlnWHvSlFGGNOcmUVaEb3xVt/Dh4zRdOMskJSKHioBa3lb1HuttiQ45u1+PKsirYg+J6uViT7EzlNI1HMPPUpU/7y92BfT5llfpIEKmojhDhI6dvrTfzbVoe2nv/wH5+trdc83aGwAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAxNy0wOS0wMVQxMDoyNDozNiswMjowMORVb1wAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMTctMDktMDFUMTA6MjQ6MzYrMDI6MDCVCNfgAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAAA10RVh0VGl0bGUAVHdpdHRlcpMAsEgAAABXelRYdFJhdyBwcm9maWxlIHR5cGUgaXB0YwAAeJzj8gwIcVYoKMpPy8xJ5VIAAyMLLmMLEyMTS5MUAxMgRIA0w2QDI7NUIMvY1MjEzMQcxAfLgEigSi4A6hcRdPJCNZUAAAAASUVORK5CYII="/></a></li><li style="display:inline-block;margin-right:1rem"><a href="https://github.com//alexisjanvier"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAQAAADZc7J/AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAAmJLR0QA/4ePzL8AAAAJcEhZcwAAAjcAAAI3AfcGRMIAAAAHdElNRQfhCQEKFycJftO4AAAC2ElEQVRIx62VTUhUURTHf/c10/hJ+VH6wtqVWhi0qHEhItIiKhzbtCncRFSLWQhRJubrjTqLXAjZoqKPlVA7B0JXCUIIOqiLIkcNizRGEfxoBptpdF6LefPmOTM5Cp3NOx/3/7/3nHfPPUIjVXptq/Wag0pkZMCPnynhKRhyhlPXimQCtxxp5xr5aXgD9Fldrf4dCNQs2mgmh3/LBj10KqG0BGop/djZWZYpZoxGZTHukOJKRxVe7CyTi4O3bKTZ+zV25TAj2PF2VCWdQC3FSxkwrVQAPM7/7RRLzO2bs6yFiigWR7Vx5TuA+pIbwAJnY6ew6Ln3U2be7l4At2GsM8eYseO0BlBGv1qnhOIptGXMPSFR/WunTa+BW6bZCE9mwmuvmNfVZrcMEkTajR8XsrRkIlDWxANdzYm0g3hiW1k2rs0L5VbmHHptK8FY7QgUHpJW6023bj4zHJxhvuhq/mq9pDlMsbVdFtK4JZpDojLhF7m7JMgztEoJ2VThwj0TyBZkQCPICjMs7ZLgJ0EKKMGCHO+FLbKpoEE9kRmtXmCdTfbHLqF4NMNxU/QH9kSnpYWfY4Aiw5yV2P5AHGPCdWnH3T+Y4OC3MEWtbgQZ5DKy9l79iEcajM4qfwxglnQm6uAKySlOScKTqK0YphofUEN39DPXE+vEjegI91PgCI9UMEQgbmrd0pbUxCwAXuVNYqH2HF+ajAIFQ5IzTJ/hyI6+s36lDid3qEVTs0C9C2qOssl4GoI+Z9gCVlekyejHU+FnttstT3XrJBPkAdUM8SsFvmF1gQStfnpM7qvhb6pP9bluAqd1Xw0kEjWkp9Uff5E6GTUFDlBOuVYEokT3HOm1kTxARukEnUAJ0chCaoqaiGsrgqxtoQUaY9PBmAsdVdGBbQ/rOsMcZJDzTNJAIcVmuHTx4Sf9R+5xsMQOn26wgLJIHV1pRsq2ytNFnblb/u9wjctexvtf2qD0QeZRdFEAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTctMDktMDFUMTA6MjM6MzkrMDI6MDDwwQTMAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE3LTA5LTAxVDEwOjIzOjM5KzAyOjAwgZy8cAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAMdEVYdFRpdGxlAEdpdEh1YlTKy1sAAABXelRYdFJhdyBwcm9maWxlIHR5cGUgaXB0YwAAeJzj8gwIcVYoKMpPy8xJ5VIAAyMLLmMLEyMTS5MUAxMgRIA0w2QDI7NUIMvY1MjEzMQcxAfLgEigSi4A6hcRdPJCNZUAAAAASUVORK5CYII="/></a></li></ul></header><div><div class="postIntro"><h1>Découvrir les service workers</h1><p class="date">Publié le <!-- -->21 mars 2017</p></div><div><img class="responsive" src="/images/blog/serviceworkers/simple_schema-edited.jpg" alt="Image sourced by Google and modified by author." />
<p>Il y a quelque temps, nous nous sommes confrontés à un nouveau besoin client : un mode d'édition offline dans une application mobile. Si plusieurs solutions s'offraient à nous, l’idée des service workers semblait prometteuse. Elle s'apparente à un proxy : dans cette configuration, le mode offline est rendu possible par un script chargé indépendamment de l’application cliente elle-même, et capable de réagir aux requêtes réseau.</p>
<p>L'idée a été écartée en raison du rapport coût / bénéfice de ce mode développement pour le client, et d'une autre raison que vous découvrirez à la fin de ce billet. Néanmoins, nous avons poursuivi l'exploration lors de hack days, pour comprendre exactement les implications de cette nouvelle technologie.</p>
<p>Ce billet est notre retour d'expérience sur un prototype très simple, un gestionnaire de playlist, qui fonctionne en mode offline.</p>
<p>Le code des exemples à suivre est <a href="https://github.com/marmelab/service-worker-demo">disponible sur Github</a>.</p>
<h2>Première prise de contact</h2>
<p>On commence avec une page statique très simple, comprenant deux fichiers CSS, deux images, un fichier de fonts et un fichier js.</p>
<img class="medium" src="/images/blog/serviceworkers/appBootstraped-t00.png" />
<p>Nous allons maintenant créer le fichier du service worker: <code class="language-text">service-worker.js</code>,</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> version <span class="token operator">=</span> <span class="token string">'01'</span><span class="token punctuation">;</span>

self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span> event <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'First service worker log'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Pour l'appeler dans notre page HTML, on rajoute:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'serviceWorker'</span> <span class="token keyword">in</span> navigator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'service-worker.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> scope<span class="token punctuation">:</span> <span class="token string">'/'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">mainMessage</span><span class="token punctuation">(</span><span class="token string">'notify'</span><span class="token punctuation">,</span> <span class="token string">'Service worker is started'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">mainMessage</span><span class="token punctuation">(</span><span class="token string">'alert'</span><span class="token punctuation">,</span> <span class="token string">'Service worker registration failed with '</span> <span class="token operator">+</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">mainMessage</span><span class="token punctuation">(</span><span class="token string">'alert'</span><span class="token punctuation">,</span> <span class="token string">'Your browser do not support Service Worker'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Dans cet exemple, la fonction <code class="language-text">mainMessage</code> affiche le message passé en paramètre dans le gros cartouche gris-vert à côté du lapin. Ca permet de voir ce qui se passe !</p>
<img class="medium" src="/images/blog/serviceworkers/started.png" />
<p>Remarque: Il est indispensable de <strong>tester le support du service worker par le navigateur</strong> (<code class="language-text">&#39;serviceWorker&#39; in navigator</code>). En effet, l'un des problèmes, mais non des moindres, est que les services worker ne sont pas disponibles sur <a href="http://caniuse.com/#feat=serviceworkers">tous les navigateurs</a>. Pour faire court, on y a accès avec <code class="language-text">Chrome</code>, <code class="language-text">Firefox</code> et <code class="language-text">Opera</code>, mais ni avec <code class="language-text">IE</code> ni avec <code class="language-text">Safari</code>. La bonne nouvelle, c'est que ces navigateurs supportant les services workers implémentent également bien l'ES2015.</p>
<p>Attention: <strong>Le script s'exécute dans un thread séparé et vit ensuite en tâche de fond, que l'application soit ouverte ou pas</strong> ! On remarque ainsi lorsque l'on recharge notre page que le <code class="language-text">console.log(&#39;First service worker log&#39;)</code> n'affiche plus rien. Ce comportement s'explique par le cycle de vie du service.</p>
<p>Mais comment alors debugger ce service worker ? Les navigateurs offrent des outils dédiés pour cela:</p>
<ul>
<li>Firefox : <code class="language-text">about:serviceworkers</code></li>
<li>Chrome : <code class="language-text">chrome://serviceworker-internals/</code></li>
</ul>
<img class="medium" src="/images/blog/serviceworkers/chromeDebug.png" />
<h2>Le cycle de vie d'un service worker</h2>
<p>Mettons à jour le fichier <code class="language-text">service-worker.js</code></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> version <span class="token operator">=</span> <span class="token string">'02'</span><span class="token punctuation">;</span>

self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span> event <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Log from event "INSTALL" in service worker version '</span> <span class="token operator">+</span> version<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> event <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Log from event "FETCH" in service worker version '</span> <span class="token operator">+</span> version<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'activate'</span><span class="token punctuation">,</span> event <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Log from event "ACTIVATE" in service worker version '</span> <span class="token operator">+</span> version<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>L'ordre d'exécution des <code class="language-text">console.log</code> illustre le cycle de vie du service worker :</p>
<img class="medium" src="/images/blog/serviceworkers/sw-3events-t02.gif" />
<p>On constate que les évènements <code class="language-text">install</code> et <code class="language-text">activate</code> ne sont exécutés qu'une fois, contrairement au <code class="language-text">fetch</code> qui est appelé de nombreuses fois (à chaque appel réseau en fait). Cela s'explique très bien par le fonctionnement de notre service :</p>
<ol>
<li>
<p>Le navigateur installe le service worker : c'est l'évènement <code class="language-text">install</code>,</p>
</li>
<li>
<p>le navigateur active ce nouveau service worker (s'il le peut, comme nous allons le voir) : c'est l'évènement <code class="language-text">activate</code>,</p>
</li>
<li>
<p>une fois activé, le service worker va pouvoir intercepter toutes les requêtes réseau des instances de l'application : c'est l'évènement <code class="language-text">fetch</code>.</p>
</li>
</ol>
<p>Si <code class="language-text">install</code> et <code class="language-text">fetch</code> sont simples à comprendre, <code class="language-text">activate</code> m'a semblé moins évident. Cet événement est lié au fait qu'un service worker s'exécute en arrière-plan pour toutes les instances de l'application en cours, comme plusieurs onglets ouverts sur la même application. Le navigateur va pouvoir installer une nouvelle version du service worker dès qu'il la reçoit, mais il ne l'activera que lorsque <strong>aucune session de l'application ne sera en cours d'exécution</strong>.</p>
<p>Par exemple, mettons à jour <code class="language-text">service-worker.js</code> :</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"> <span class="token keyword">const</span> version <span class="token operator">=</span> <span class="token string">'03'</span><span class="token punctuation">;</span></code></pre></div>
<p>Le navigateur est capable d'identifier tout changement au niveau du fichier du service worker, le mettant à jour en conséquence. Le navigateur va bien recevoir la nouvelle version et va l'installer.</p>
<p><strong>Conseil</strong> : Comme tout fichier js, un fichier de service worker peut être mis en cache par le navigateur. Pensez donc à vos en-têtes HTTP de cache si vous voulez une mise à jour immédiate de votre service worker.</p>
<p>Par contre, cette nouvelle version ne sera <em>activée</em> que lorsque l'on aura quitté toutes les instances de l'application, pour ensuite la relancer.</p>
 <img class="responsive" src="/images/blog/serviceworkers/sw-3events-t03.gif" />
<p>Ce comportement potentiellement troublant peut être court-circuité via les évènements <code class="language-text">install</code> et  <code class="language-text">activate</code> de la manière suivante :</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> version <span class="token operator">=</span> <span class="token string">'04'</span><span class="token punctuation">;</span>

self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span> event <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Log from event "INSTALL" in service worker version '</span> <span class="token operator">+</span> version<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> self<span class="token punctuation">.</span><span class="token function">skipWaiting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'activate'</span><span class="token punctuation">,</span> event <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Log from event "ACTIVATE" in service worker version '</span> <span class="token operator">+</span> version<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> self<span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">claim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<h2>Premier bilan</h2>
<p>Nous venons de voir plusieurs points fondamentaux si l'on veut se lancer dans l'utilisation des services workers:</p>
<ul>
<li>
<p>la <strong>compatibilité</strong> : les services workers ne sont pas disponibles sur tous les navigateurs. On va donc difficilement pouvoir baser le fonctionnement d'une application sur leur utilisation.</p>
</li>
<li>
<p>le <strong>cycle de vie dans un thread séparé</strong>: un service worker va s'installer puis s'activer dans un processus indépendant. Ensuite, il pourra intercepter toutes les requêtes réseau effectuées par n'importe quelle instance de l'application au sein du navigateur.</p>
</li>
<li>
<p>le fonctionnement <strong>asynchrone</strong> : ce point n'a pas encore été mis en avant, même s’il est apparu dans la version 2 du service worker d'exemple. Tout ce qui se passe au sein du service worker doit être asynchrone. En effet, il ne doit pas bloquer l'exécution de l'application.</p>
</li>
<li>
<p>le <strong>https est obligatoire</strong> : toutes les requêtes réseau doivent être en https (sauf pour <code class="language-text">localhost</code>, ce qui nous simplifie grandement le développement). Cela semble assez logique tant le pouvoir de nuisance d'un service worker redirigeant vers un site malintentionné semble grand.</p>
</li>
</ul>
<h2>Un site hors ligne</h2>
<p>Il est maintenant temps de configurer notre service worker afin de permettre la consultation "offline" de notre application.</p>
<h3>Phase 'install'</h3>
<p>Lors de cette phase d'installation, vous allons pouvoir indiquer au service quels sont les éléments qui doivent être mis en cache. Pour faire simple au début, nous allons mettre en cache tous les fichiers de notre application, sauf le fichier de fonts.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> version <span class="token operator">=</span> <span class="token string">'05'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">CACHE_NAME</span> <span class="token operator">=</span> <span class="token string">'sw-demo_1'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> urlsToCache <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'/index.html'</span><span class="token punctuation">,</span>
    <span class="token string">'/playlist.html'</span><span class="token punctuation">,</span>
    <span class="token string">'/css/normalize.css'</span><span class="token punctuation">,</span>
    <span class="token string">'/css/sw-demo.css'</span><span class="token punctuation">,</span>
    <span class="token string">'/images/catWorker.jpg'</span><span class="token punctuation">,</span>
    <span class="token string">'/images/logo.png'</span><span class="token punctuation">,</span>
    <span class="token string">'/covers/avecpasdcasque.jpg'</span><span class="token punctuation">,</span>
    <span class="token string">'/covers/ryleywalker.jpg'</span><span class="token punctuation">,</span>
    <span class="token string">'/covers/xeniaRubinos.jpg'</span><span class="token punctuation">,</span>
    <span class="token string">'/js/sw-demo.js'</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>
        caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token constant">CACHE_NAME</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>cache <span class="token operator">=></span> cache<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>urlsToCache<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> self<span class="token punctuation">.</span><span class="token function">skipWaiting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// to be continued</span></code></pre></div>
<p>Comme évoqué précédemment, tout est asynchrone:</p>
<ul>
<li><code class="language-text">event.waitUntil</code> est une fonction qui attend la résolution d'une promesse pour considérer l'évènement comme terminé.</li>
<li><code class="language-text">caches.open</code> retourne un promesse lorsque le cache à utiliser est ouvert. En effet, le service worker va avoir accès à la méthode <code class="language-text">caches</code> permettant de nommer plusieurs clés de cache au sein du service. On l'utilisera ici pour versionner le cache.</li>
<li><code class="language-text">cache.addAll</code> va renvoyer une promesse lorsque l'ajout de tous les éléments sera terminé.</li>
</ul>
<img class="responsive" src="/images/blog/serviceworkers/sw-cache-storage.png" />
<h3>Phase 'activate'</h3>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'activate'</span><span class="token punctuation">,</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>
        caches<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>keys <span class="token operator">=></span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>keys
                    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>key <span class="token operator">=></span> key <span class="token operator">!==</span> <span class="token constant">CACHE_NAME</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>key <span class="token operator">=></span> caches<span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> self<span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">claim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// to be continued</span></code></pre></div>
<p>Nous profitons de l’existence de la phase d'activation pour supprimer les éventuels caches créés par une précédente version du service worker.
Ce n'est pas obligatoire, et ceci n'est valable que parce que nous avons choisi de versionner ce cache...</p>
<h3>Phase 'fetch'</h3>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span>
        <span class="token function">fetch</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Maintenant que notre service worker est installé et activé, nous pouvons profiter de sa capacité à intercepter les requêtes réseau.</p>
<p>Dans notre exemple, simplissime, nous allons juste répondre à l’événement <code class="language-text">fetch</code> en retournant le résultat effectif de cette requête avec <code class="language-text">fetch(event.request)</code>.</p>
<p>Jusque là, le service worker ne modifie pas le comportement attendu de l'application. Par contre, en ajoutant un <code class="language-text">catch</code> pouvant correspondre à un retour en erreur du serveur - pour notre exemple on généralisera au cas "offline" - le service worker va pouvoir aller chercher dans son cache <code class="language-text">caches.match(event.request)</code> si cette requête est présente. Si c'est le cas, c'est ce qui sera retourné au navigateur, rendant l’application disponible offline.</p>
<p>Vous pouvez tester ce comportement en vous rendant sur <a href="https://sw.alexisjanvier.space/">l’application d'exemple</a>, et en coupant votre connexion réseau.</p>
<h2>Conclusion</h2>
<p>Bien qu'encore considérés comme expérimentaux, les services workers sont d’ores et déjà bien implémentés sur Chrome et Firefox. Leur non-prise en charge par IE ou Safari va sans doute limiter leur utilisation en production. Par exemple, l'application de notre client citée en introduction visait principalement les utilisateurs iOS, d'où l'abandon de cette technologie.</p>
<p>Leur relative simplicité laisse une grande liberté au développeur sur les comportements implémentés. Si l'exemple présenté dans ce post est vraiment très simple, on peut facilement envisager des stratégies de cache beaucoup plus complexes : adapter les réponses en fonction des médias demandés, adopter une politique de <em>"cache first"</em> et de prérequêtes afin d'accélérer l'affichage d'une application... Je pense même qu'un des risques est de pouvoir y coder trop de logique métier.</p>
<p>Son comportement transparent va également obliger à bien penser <a href="https://developers.google.com/web/fundamentals/instant-and-offline/offline-ux">l'interface utilisateur</a> afin de ne pas rendre l'application déroutante (statut online/offline, données à jour, données synchronisées, ...).</p>
<p>Mais, et en évoquant d'autres possibilités annoncées dans la spécification des service workers, comme le <a href="https://www.w3.org/TR/push-api/">Push API</a> ou le <a href="https://wicg.github.io/BackgroundSync/spec/">Web Background Synchronization</a>, c'est sans aucun doute une technologie à tester et à suivre dès que l'on s'intéresse aux applications web, mobiles ou non.</p></div></div></div></header></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-blog-post-js","jsonName":"decouvrir-les-service-workers-38a","path":"/decouvrir-les-service-workers"};window.dataPath="116/path---decouvrir-les-service-workers-38-a-c2f-zQrmxJlwkmlQoiWdzCiPpDf6s";/*]]>*/</script><script src="/webpack-runtime-42bff34e6b7c3da03b9b.js" async=""></script><script src="/0-a2cc8ebe3fc1c85def50.js" async=""></script><script src="/1-175a282ba0c8b68cf24f.js" async=""></script><script src="/app-607e8de0d9b68e3b2976.js" async=""></script><script src="/component---src-templates-blog-post-js-4c703bcb2bfaced24bd4.js" async=""></script></body></html>