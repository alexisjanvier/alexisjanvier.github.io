{"data":{"markdownRemark":{"html":"<p>We are currently migrating a customer project from a Symfony application to a React application with server-side rendering. Out stack includes React Router V3, Redux, and Redux-Saga. But as features add up, the code becomes harder and harder to maintain, and the routing more and more complex. </p>\n<p>During the summer, the Product Owner agreed to prioritize two technical tasks: \"Migrate to React Router 4\" and \"Improve Performance With Code Splitting\". We already migrated a React application to React Router V4 in the past (see <a href=\"https://codeburst.io/react-router-v4-unofficial-migration-guide-5a370b8905a\">React Router v4 Unofficial Migration Guide</a>. However, we wanted to validate the viability of the new stack, including React Router v4 (RRV4), Redux Saga, Code splitting, and compatible with server side rendering (SSR). </p>\n<p>This post details the implementation of a Proof-of-Concept (POC) validating this architecture.</p>\n<h2>Project Bootstrap</h2>\n<p>We started a new application with the same routing constraints as those encountered in the customer application. You will find <a href=\"https://github.com/alexisjanvier/universal-react/releases/tag/step-1\">on Github</a> the code of this clean and fresh application, not yet including Redux and or asynchronous calls to recover data.</p>\n<p>It is built with the following dependencies:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">// in package.json\n<span class=\"token property\">\"dependencies\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"date-fns\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^1.28.5\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"lodash.debounce\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^4.0.8\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"material-ui\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^1.0.0-alpha.21\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"material-ui-icons\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^1.0.0-alpha.19\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"prop-types\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^15.5.10\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"query-string\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^4.3.4\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"react\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^15.6.1\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"react-dom\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^15.6.1\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"react-router-dom\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^4.1.1\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"typeface-roboto\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"0.0.31\"</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>And a simple React Router V4 routing:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// in src/shared/app/index.js</span>\n<span class=\"token operator\">&lt;</span>Switch<span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span>Route exact path<span class=\"token operator\">=</span><span class=\"token string\">\"/\"</span> component<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>HomePage<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span>Route path<span class=\"token operator\">=</span><span class=\"token string\">\"/playlists/:playlistId(pl-[a-z]{0,4})\"</span> component<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>PlaylistPage<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span>Route path<span class=\"token operator\">=</span><span class=\"token string\">\"/playlists\"</span> component<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>PlayListsPage<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span>Route path<span class=\"token operator\">=</span><span class=\"token string\">\"/search-album\"</span> component<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>SearchAlbumPage<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span>Route path<span class=\"token operator\">=</span><span class=\"token string\">\"/albums/:albumSlug\"</span> component<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>AlbumPage<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>Switch<span class=\"token operator\">></span></code></pre></div>\n<h3>Visualizing The Benefits</h3>\n<p>The target is to optimize the production code, by generating smaller JavaScript files. We will therefore have to find tools enabling to show us this optimization. And <a href=\"https://www.npmjs.com/package/webpack-bundle-analyzer\">webpack-bundle-analyzer</a> seems to be an excellent candidate for that.</p>\n<p>For the moment Webpack is generating only one file for the whole application:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// in webpack.config.js</span>\n  entry<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    client<span class=\"token punctuation\">:</span> <span class=\"token template-string\"><span class=\"token string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>srcPath<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/client/index.js`</span></span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n  output<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    path<span class=\"token punctuation\">:</span> distPath<span class=\"token punctuation\">,</span>\n    filename<span class=\"token punctuation\">:</span> <span class=\"token string\">'[name].js'</span><span class=\"token punctuation\">,</span>\n    publicPath<span class=\"token punctuation\">:</span> <span class=\"token string\">'/assets/'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>To visualize the composition of this single file with the <code class=\"language-text\">webpack-bundle-analyzer</code>, we just have to add it to the webpack configuration,</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// in webpack.config.js</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NODE_ENV</span>  <span class=\"token operator\">===</span>  <span class=\"token string\">'analyse'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  plugins<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">BundleAnalyzerPlugin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And launch Webpack into the right environment:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">    NODE_ENV<span class=\"token operator\">=</span>analyse ./node_modules/.bin/webpack --config webpack.config.js -p</code></pre></div>\n<p>The result is a fat file (274Kb gzipped) in which we find the names of all the node modules, and our own code (the small vertical bar to the right!).</p>\n<p><img src=\"/images/blog/code-splitting/startingApplicationBundle.png\" alt=\"startingApplicationBundle.png\"></p>\n<p>So we will have to split this fat file into several smaller ones, fetched only when needed. That's a neat way to visualize code splitting.</p>\n<h2>First Split</h2>\n<p>We first split the bundle into 2 separate chunks: dependencies on one side (<code class=\"language-text\">vendors.js</code>), and the business code on the other side (<code class=\"language-text\">clients.js</code>). Here is the Webpack configuration:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// in webpack.config.js</span>\nentry<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n  client<span class=\"token punctuation\">:</span> <span class=\"token template-string\"><span class=\"token string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>srcPath<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/client/index.js`</span></span><span class=\"token punctuation\">,</span>\n  vendor<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'react'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'react-dom'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'react-router-dom'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\noutput<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n  path<span class=\"token punctuation\">:</span> distPath<span class=\"token punctuation\">,</span>\n  filename<span class=\"token punctuation\">:</span> <span class=\"token string\">'[name].js'</span><span class=\"token punctuation\">,</span>\n  publicPath<span class=\"token punctuation\">:</span> <span class=\"token string\">'/assets/'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>Let's analyze these 2 chunks generated by Webpack:</p>\n<p><img src=\"/images/blog/code-splitting/console1.png\" alt=\"Capture d&#x27;écran de 2017-09-14 18-28-48.png\"></p>\n<p><img src=\"/images/blog/code-splitting/vendorChunkStep1.png\" alt=\"vendorChunkStep1.png\"></p>\n<p>It makes sense: Webpack has created a <code class=\"language-text\">vendors. js</code> file as we asked it, but it also created the <code class=\"language-text\">client. js</code> file including all <code class=\"language-text\">import</code> present in our code. As result, we almost doubled the weight of Javascript :(</p>\n<p>To fix that, we'll use the <a href=\"https://webpack.js.org/plugins/commons-chunk-plugin/\">CommonsChunkPlugin</a> which deduplicates the modules specified in the <code class=\"language-text\">vendor</code> entry by not including them in <code class=\"language-text\">client.js</code> file anymore.</p>\n<p>This is the final Webpack configuration:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// in webpack.config.js</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> BundleAnalyzerPlugin <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span>  <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'webpack-bundle-analyzer'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span>  path  <span class=\"token operator\">=</span>  <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span>  webpack  <span class=\"token operator\">=</span>  <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'webpack'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span>  srcPath  <span class=\"token operator\">=</span>  path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'src'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span>  distPath  <span class=\"token operator\">=</span>  path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'dist'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span>  plugins  <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n  <span class=\"token keyword\">new</span> <span class=\"token class-name\">webpack<span class=\"token punctuation\">.</span>optimize<span class=\"token punctuation\">.</span>CommonsChunkPlugin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    name<span class=\"token punctuation\">:</span> <span class=\"token string\">'vendor'</span><span class=\"token punctuation\">,</span>\n    minChunks<span class=\"token punctuation\">:</span> <span class=\"token number\">Infinity</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NODE_ENV</span>  <span class=\"token operator\">===</span>  <span class=\"token string\">'analyse'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  plugins<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">BundleAnalyzerPlugin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  context<span class=\"token punctuation\">:</span> srcPath<span class=\"token punctuation\">,</span>\n  target<span class=\"token punctuation\">:</span> <span class=\"token string\">'web'</span><span class=\"token punctuation\">,</span>\n\n  entry<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    client<span class=\"token punctuation\">:</span> <span class=\"token template-string\"><span class=\"token string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>srcPath<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/client/index.js`</span></span><span class=\"token punctuation\">,</span>\n    vendor<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'react'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'react-dom'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'react-router-dom'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n  output<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    path<span class=\"token punctuation\">:</span> distPath<span class=\"token punctuation\">,</span>\n    filename<span class=\"token punctuation\">:</span> <span class=\"token string\">'[name].js'</span><span class=\"token punctuation\">,</span>\n    publicPath<span class=\"token punctuation\">:</span> <span class=\"token string\">'/assets/'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n  resolve<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    modules<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'node_modules'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'src'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    extensions<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'*'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'.js'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'.json'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n  module<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    rules<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span>\n        test<span class=\"token punctuation\">:</span>  <span class=\"token regex\">/\\.js$/</span><span class=\"token punctuation\">,</span>\n        exclude<span class=\"token punctuation\">:</span>  <span class=\"token regex\">/(node_modules)/</span><span class=\"token punctuation\">,</span>\n        loader<span class=\"token punctuation\">:</span> <span class=\"token string\">'babel-loader'</span><span class=\"token punctuation\">,</span>\n        query<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> compact<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n  plugins<span class=\"token punctuation\">,</span>\n  devtool<span class=\"token punctuation\">:</span> <span class=\"token string\">'source-map'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>And the final result:</p>\n<p><img src=\"/images/blog/code-splitting/vendorChunkStep2.png\" alt=\"vendorChunkStep2.png\"></p>\n<p><img src=\"/images/blog/code-splitting/vendorChunkStep3.png\" alt=\"vendorChunkStep3.png\"></p>\n<p>Much better! <code class=\"language-text\">CommonsChunkPlugin</code> is able to do much more things to optimize our code. I suggest you read the post <a href=\"https://medium.com/webpack/webpack-bits-getting-the-most-out-of-the-commonschunkplugin-ab389e5f318\">\"webpack bits: Getting the most out of the CommonsChunkPlugin\"</a> if you want to go deeper into the subject.</p>\n<p>(<em>The code of this step is available on the tag <a href=\"https://github.com/alexisjanvier/universal-react/releases/tag/step-2\">step-2</a> in the GitHub repository</em>)</p>\n<p>Now we'll have to split the <code class=\"language-text\">client.js</code> file. But before that, we will implement the Server-Side Rendering.</p>\n<h2>Setting Up Server-Side-Rendering</h2>\n<p>One of the advantages of React is to have the SSR \"out of the box\". This is done thanks to the <code class=\"language-text\">renderToString</code> method, which makes it possible to render our React application as a ... string, in Node.js.</p>\n<p>The behaviour of React Router V4 particularly interests us: To make SSR possible, RRV4 has a specific router, the <a href=\"https://reacttraining.com/web/api/StaticRouter\"><code class=\"language-text\">&lt;StaticRouter&gt;</code></a>, that we use on the server instead of the <a href=\"https://reacttraining.com/web/api/BrowserRouter\"><code class=\"language-text\">&lt;BrowserRouter&gt;</code></a> used on the client side.</p>\n<p>The code will be organized into three separate folders.</p>\n<p><img src=\"/images/blog/code-splitting/folders.png\" alt=\"Capture d&#x27;écran de 2017-09-15 09-10-43.png\"></p>\n<h3>Shared Folder</h3>\n<p>This is where you will find all the business code of our application, including the routing.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// in src/shared/app/index.js</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">App</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n  <span class=\"token operator\">&lt;</span>div<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>MainMenu <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>Switch<span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>Route  exact  path<span class=\"token operator\">=</span><span class=\"token string\">\"/\"</span>  component<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>HomePage<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>Route  path<span class=\"token operator\">=</span><span class=\"token string\">\"/playlists/:playlistId(pl-[a-z]{0,4})\"</span>  component<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>PlaylistPage<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>Route  path<span class=\"token operator\">=</span><span class=\"token string\">\"/playlists\"</span>  component<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>PlayListsPage<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>Route  path<span class=\"token operator\">=</span><span class=\"token string\">\"/search-album\"</span>  component<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>SearchAlbumPage<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>Route  path<span class=\"token operator\">=</span><span class=\"token string\">\"/albums/:albumSlug\"</span>  component<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>AlbumPage<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>Switch<span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3>Client Folder</h3>\n<p>This is where you will find all the browser-specific code. For the moment, it's just calling our application in the router dedicated to browsers.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// in src/client/index.js</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> render <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react-dom'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> BrowserRouter <span class=\"token keyword\">as</span> Router <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react-router-dom'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> App <span class=\"token keyword\">from</span> <span class=\"token string\">'../shared/app'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Main</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Component</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n            <span class=\"token operator\">&lt;</span>Router<span class=\"token operator\">></span>\n                <span class=\"token operator\">&lt;</span>App <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n            <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>Router<span class=\"token operator\">></span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Server Folder</h3>\n<p>It's an <code class=\"language-text\">express</code> server. One of its route renders the application into a string. The <code class=\"language-text\">&lt;StaticRouter&gt;</code> router makes it possible to choose the state of the application to render according to the request. This string is injected into an html template to generate the final server response. The client then uses the client code linked in this response to become a Single-Page React Application again.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// in src/server/index.js</span>\n<span class=\"token keyword\">import</span> express <span class=\"token keyword\">from</span> <span class=\"token string\">'express'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> ReactDOMServer <span class=\"token keyword\">from</span> <span class=\"token string\">'react-dom/server'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> StaticRouter <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react-router-dom'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> App <span class=\"token keyword\">from</span> <span class=\"token string\">'../shared/app'</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// render is used to inject html in a globale template</span>\n<span class=\"token keyword\">import</span> render <span class=\"token keyword\">from</span> <span class=\"token string\">'./render'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Serve client.js and vendor.js</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/assets'</span><span class=\"token punctuation\">,</span> express<span class=\"token punctuation\">.</span><span class=\"token keyword\">static</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./dist'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'*'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> context <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> appWithRouter <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n        <span class=\"token operator\">&lt;</span>StaticRouter location<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>req<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">}</span> context<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>context<span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n            <span class=\"token operator\">&lt;</span>App <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>StaticRouter<span class=\"token operator\">></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        res<span class=\"token punctuation\">.</span><span class=\"token function\">redirect</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">const</span> html <span class=\"token operator\">=</span> ReactDOMServer<span class=\"token punctuation\">.</span><span class=\"token function\">renderToString</span><span class=\"token punctuation\">(</span>appWithRouter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span>html<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">3000</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Demo app listening on port 3000'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>And it all works out pretty well! The easiest way to test it is to disable JavaScript on the browser.</p>\n<p><img src=\"/images/blog/code-splitting/testSSR.gif\" alt=\"testSSR.gif\"></p>\n<p>(<em>The code of this step is available on the tag <a href=\"https://github.com/alexisjanvier/universal-react/releases/tag/step-3\">step-3</a></em>)</p>\n<h2>Code Splitting Step 2</h2>\n<p>And once again, webpack comes into play. If we refer to the <a href=\"https://webpack.js.org/guides/code-splitting/\">documentation</a>, there are three general approaches to code splitting available:</p>\n<blockquote>\n<ul>\n<li>Entry Points: Manually split code using <a href=\"https://webpack.js.org/configuration/entry-context\"><code class=\"language-text\">entry</code></a> configuration.</li>\n<li>Prevent Duplication: Use the <a href=\"https://webpack.js.org/plugins/commons-chunk-plugin\"><code class=\"language-text\">CommonsChunkPlugin</code></a> to dedupe and split chunks.</li>\n<li>Dynamic Imports: Split code via inline function calls within modules.</li>\n</ul>\n</blockquote>\n<p>Good news, we have already applied the first two approaches. So the dynamic approach remains to be applied. Basically, webpack can isolate the code called dynamically (asynchronously) in a chunk. It can also generate the code to call the right chunk at the right time.</p>\n<p>To call code dynamically, we will have to use the syntax <a href=\"https://webpack.js.org/api/module-methods#import-\"><code class=\"language-text\">import()</code></a> (that conforms to the <a href=\"https://github.com/tc39/proposal-dynamic-import\">ECMAScript proposal</a>) or the WebPack-specific syntax <a href=\"https://webpack.js.org/api/module-methods#require-ensure\"><code class=\"language-text\">require.ensure</code></a>.</p>\n<p>Which would give for a React component:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Home</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n  state <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> Component<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">componentWillMount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./Home'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>Component <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> Component <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> Component <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state\n    <span class=\"token keyword\">return</span> Component <span class=\"token operator\">?</span> <span class=\"token operator\">&lt;</span>Component <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span>props<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span> <span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><em>(This example comes from the blog post <a href=\"https://medium.com/smooth-code/introducing-loadable-components-%EF%B8%8F-646dd3ab0aa6\">Introducing loadable-components</a>)</em></p>\n<p>Because we don't want to have to transform all our components, we use a <a href=\"https://facebook.github.io/react/docs/higher-order-components.html\">Higher-Order Component</a>: <a href=\"https://www.npmjs.com/package/loadable-components\">loadable-components</a>.</p>\n<p>Thus, we no longer call our page components synchronously in routing, but asynchronously by mapping them into this HOC. That's how Webpack can create a chunk by road.</p>\n<p><code class=\"language-text\">src/shared/app/index.js</code> does not change.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// in src/shared/app/index.js</span>\n<span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Route<span class=\"token punctuation\">,</span> Switch <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react-router-dom'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">as</span> Routes <span class=\"token keyword\">from</span> <span class=\"token string\">'./routes'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> MainMenu <span class=\"token keyword\">from</span> <span class=\"token string\">'./mainMenu'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">App</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>div<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>MainMenu <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>Switch<span class=\"token operator\">></span>\n            <span class=\"token operator\">&lt;</span>Route exact path<span class=\"token operator\">=</span><span class=\"token string\">\"/\"</span> component<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>Routes<span class=\"token punctuation\">.</span>HomePage<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n            <span class=\"token operator\">&lt;</span>Route path<span class=\"token operator\">=</span><span class=\"token string\">\"/playlists/:playlistId(pl-[a-z]{0,4})\"</span> component<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>Routes<span class=\"token punctuation\">.</span>PlaylistPage<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n            <span class=\"token operator\">&lt;</span>Route path<span class=\"token operator\">=</span><span class=\"token string\">\"/playlists\"</span> component<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>Routes<span class=\"token punctuation\">.</span>PlayListsPage<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n            <span class=\"token operator\">&lt;</span>Route path<span class=\"token operator\">=</span><span class=\"token string\">\"/search-album\"</span> component<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>Routes<span class=\"token punctuation\">.</span>SearchAlbumPage<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n            <span class=\"token operator\">&lt;</span>Route path<span class=\"token operator\">=</span><span class=\"token string\">\"/albums/:albumSlug\"</span> component<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>Routes<span class=\"token punctuation\">.</span>AlbumPage<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>Switch<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> App<span class=\"token punctuation\">;</span></code></pre></div>\n<p>But everything happens in <code class=\"language-text\">src/shared/app/routes.js</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// src/shared/app/routes.js</span>\n<span class=\"token keyword\">import</span> loadable <span class=\"token keyword\">from</span> <span class=\"token string\">'loadable-components'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> AlbumPage <span class=\"token operator\">=</span> <span class=\"token function\">loadable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../albums/AlbumPage'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> HomePage <span class=\"token operator\">=</span> <span class=\"token function\">loadable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../home/HomePage'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> PlaylistPage <span class=\"token operator\">=</span> <span class=\"token function\">loadable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../playlists/PlaylistPage'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> PlayListsPage <span class=\"token operator\">=</span> <span class=\"token function\">loadable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../playlists/ListPage'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> SearchAlbumPage <span class=\"token operator\">=</span> <span class=\"token function\">loadable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../albums/SearchPage'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>We must make Babel compatible with the <code class=\"language-text\">import()</code> syntax by adding <a href=\"https://github.com/airbnb/babel-plugin-dynamic-import-webpack\">the dynamic-import-webpack plugin</a></p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">// in .babelrc\n<span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"plugins\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"dynamic-import-webpack\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"presets\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string\">\"react\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">\"env\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token property\">\"targets\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token property\">\"browsers\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"last 1 version\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"ie >= 11\"</span><span class=\"token punctuation\">]</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And now it's time to see the final result:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">NODE_ENV<span class=\"token operator\">=</span>analyse ./node_modules/.bin/webpack --config webpack.client.config.js -p\nHash: 6ab25e3738d87ca6f2d5\nVersion: webpack 3.3.0\nTime: 5715ms\n     Asset       Size  Chunks             Chunk Names\n      0.js    36.5 kB       0  <span class=\"token punctuation\">[</span>emitted<span class=\"token punctuation\">]</span>\n      1.js    36.9 kB       1  <span class=\"token punctuation\">[</span>emitted<span class=\"token punctuation\">]</span>\n      2.js    11.6 kB       2  <span class=\"token punctuation\">[</span>emitted<span class=\"token punctuation\">]</span>\n      3.js    20.7 kB       3  <span class=\"token punctuation\">[</span>emitted<span class=\"token punctuation\">]</span>\n      4.js  747 bytes       4  <span class=\"token punctuation\">[</span>emitted<span class=\"token punctuation\">]</span>\n client.js     102 kB       5  <span class=\"token punctuation\">[</span>emitted<span class=\"token punctuation\">]</span>  client\n vendor.js     191 kB       6  <span class=\"token punctuation\">[</span>emitted<span class=\"token punctuation\">]</span>  vendor\nindex.html  409 bytes          <span class=\"token punctuation\">[</span>emitted<span class=\"token punctuation\">]</span></code></pre></div>\n<p><img src=\"/images/blog/code-splitting/vendorChunkWithCodeSpliting.png\" alt=\"vendorChunkWithCodeSpliting.png\"></p>\n<p>Here we are, our code is now divided into as many chunks as there are pages!</p>\n<p><img src=\"/images/blog/code-splitting/codeSplitting.gif\" alt=\"codeSplitting.gif\"></p>\n<p>(<em>The code of this step is available on the tag <a href=\"https://github.com/alexisjanvier/universal-react/releases/tag/step-4\">step-4</a></em>)</p>\n<p>But does it work with SSR?</p>\n<p><img src=\"/images/blog/code-splitting/CS-SSR-KO.gif\" alt=\"CS-SSR-KO.gif\"></p>\n<p>Nope, not yet :(</p>\n<h2>Making Code Splitting And Server-Side Rendering Work together</h2>\n<p>The explanation is easy to find: the code of our page components is now called asynchronously. However, the server-side route is synchronous. So Node can render all the code called in a classic synchronous way (as the menu bar), but not the asynchronous content of the pages.</p>\n<p>To make it work, we use the <code class=\"language-text\">getLoadableState</code> method provided by <code class=\"language-text\">loadable-components</code>. It allows us to make a pre-rendering of the application (including asynchronous calls), and extract the references of the chunks needed to render the requested page. We also have to make the express route asynchronous (with <code class=\"language-text\">async</code> and <code class=\"language-text\">await</code>).</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// in src/server/index.js</span>\n<span class=\"token keyword\">import</span> express <span class=\"token keyword\">from</span> <span class=\"token string\">'express'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> ReactDOMServer <span class=\"token keyword\">from</span> <span class=\"token string\">'react-dom/server'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> StaticRouter <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react-router-dom'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> getLoadableState <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'loadable-components/server'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> App <span class=\"token keyword\">from</span> <span class=\"token string\">'../shared/app'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> render <span class=\"token keyword\">from</span> <span class=\"token string\">'./render'</span><span class=\"token punctuation\">;</span>\n\n\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/assets'</span><span class=\"token punctuation\">,</span> express<span class=\"token punctuation\">.</span><span class=\"token keyword\">static</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./dist'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'*'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> context <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> appWithRouter <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n        <span class=\"token operator\">&lt;</span>StaticRouter location<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>req<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">}</span> context<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>context<span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n            <span class=\"token operator\">&lt;</span>App <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>StaticRouter<span class=\"token operator\">></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        res<span class=\"token punctuation\">.</span><span class=\"token function\">redirect</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">const</span> loadableState <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getLoadableState</span><span class=\"token punctuation\">(</span>appWithRouter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> html <span class=\"token operator\">=</span> ReactDOMServer<span class=\"token punctuation\">.</span><span class=\"token function\">renderToString</span><span class=\"token punctuation\">(</span>appWithRouter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span>html<span class=\"token punctuation\">,</span> loadableState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">3000</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Demo app listening on port 3000'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The reference to the chunk used by the application according to the request is injected into the global template by the <code class=\"language-text\">getScriptTag()</code> method of the <code class=\"language-text\">loadableState</code> object generated during pre-rendering:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// in src/server/render.js</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">(</span>html<span class=\"token punctuation\">,</span> loadableState<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token template-string\"><span class=\"token string\">`\n    &lt;!DOCTYPE html>\n    &lt;html lang=\"en\">\n        &lt;head>\n            &lt;meta charset=\"UTF-8\">\n            &lt;title>Get real playlists to share with Spotify&lt;/title>\n            &lt;link href=\"https://fonts.googleapis.com/icon?family=Material+Icons\" rel=\"stylesheet\">\n            &lt;link rel=\"icon\" type=\"image/png\" href=\"/assets/favicon.ico\" />\n        &lt;/head>\n        &lt;body>\n            &lt;div id=\"root\"></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>html<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&lt;/div>\n            &lt;script src=\"/assets/vendor.js\">&lt;/script>\n            &lt;script src=\"/assets/client.js\">&lt;/script>\n            </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>loadableState<span class=\"token punctuation\">.</span><span class=\"token function\">getScriptTag</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\n        &lt;/body>\n    &lt;/html>\n`</span></span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">loadableState.getScriptTag()</code> makes it possible to insert the <code class=\"language-text\">&lt;script&gt;window.__LOADABLE_COMPONENT_IDS__ = [1];&lt;/script&gt;</code> tag into the server response (here <code class=\"language-text\">[1]</code> is the homepage's chunk identifier). The client code uses this information to load the right chunk, using the <code class=\"language-text\">loadComponents</code> method provided by the `loadable-components'.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// in src/client/index.js</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> loadComponents <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span>  <span class=\"token string\">'loadable-components'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> render <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react-dom'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> BrowserRouter <span class=\"token keyword\">as</span> Router <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react-router-dom'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> App <span class=\"token keyword\">from</span> <span class=\"token string\">'../shared/app'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">Main</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>Router<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>App <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span>props<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>Router<span class=\"token operator\">></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">loadComponents</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">render</span><span class=\"token punctuation\">(</span>\n        <span class=\"token operator\">&lt;</span>Main <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n        document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'root'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Let's re-test after applying these changes (<em>available on the tag <a href=\"https://github.com/alexisjanvier/universal-react/releases/tag/step-5\">step-5</a></em>)</p>\n<p><img src=\"/images/blog/code-splitting/CS-SSR-OK.gif\" alt=\"CS-SSR-OK.gif\"></p>\n<p><strong>\\o/</strong></p>\n<h2>Redux and Saga implementation</h2>\n<p>Adding Redux does create any problem, whether with the React Router V4, oor with code splitting. But using Saga is not without difficulty, mainly for server-side rendering.</p>\n<p>n the POC app, we use Sagas to make a simple call to the Github API. We fetch a list of the latest public gists (this API call does not require any personal key, making it easier to share the code of this POC). The call is made from the homepage. The difficulty is to wait for the saga to be resolved on the server side before rendering the HTML string. We can do it with:</p>\n<ul>\n<li>a first asynchronous pre-rendering that launches the sagas (this is what we are already doing with <code class=\"language-text\">const loadableState = await getLoadableState(appWithRouter)</code> used to make the code splitting work in SSR),</li>\n<li>dispatching <a href=\"https://github.com/redux-saga/redux-saga/issues/255\">the <code class=\"language-text\">END</code> event</a>, which allows us to break the <code class=\"language-text\">while(true)</code> saga's loop inside watchers.</li>\n</ul>\n<p>I am not going deeper on this point, because it has already been done by my dear colleague <a href=\"https://twitter.com/juliendemangeon?lang=fr\">Julien</a> in his blog post <a href=\"https://marmelab.com/blog/2016/12/21/react-isomorphique-en-pratique.html\">React Isomorphique en pratique</a>.</p>\n<p>But here's what the server-side code looks like:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'*'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> store <span class=\"token operator\">=</span> <span class=\"token function\">configureStore</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> context <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> appWithRouter <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n        <span class=\"token operator\">&lt;</span>Provider store<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>store<span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n            <span class=\"token operator\">&lt;</span>StaticRouter location<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>req<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">}</span> context<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>context<span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n                <span class=\"token operator\">&lt;</span>App <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n            <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>StaticRouter<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>Provider<span class=\"token operator\">></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        res<span class=\"token punctuation\">.</span><span class=\"token function\">redirect</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">let</span> loadableState <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// .done is resolved when store.close() send an END event</span>\n    store<span class=\"token punctuation\">.</span><span class=\"token function\">runSaga</span><span class=\"token punctuation\">(</span>sagas<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>done<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> html <span class=\"token operator\">=</span> ReactDOMServer<span class=\"token punctuation\">.</span><span class=\"token function\">renderToString</span><span class=\"token punctuation\">(</span>appWithRouter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> preloadedState <span class=\"token operator\">=</span> store<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span>html<span class=\"token punctuation\">,</span> loadableState<span class=\"token punctuation\">,</span> preloadedState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Trigger sagas for component to run</span>\n    <span class=\"token comment\">// https://github.com/yelouafi/redux-saga/issues/255#issuecomment-210275959</span>\n    loadableState <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getLoadableState</span><span class=\"token punctuation\">(</span>appWithRouter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Dispatch a close event so sagas stop listening after they're resolved</span>\n    store<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The complete code is available on <a href=\"https://github.com/alexisjanvier/universal-react\">master branch</a>.</p>\n<h2>Conclusion</h2>\n<p>The target of the POC is reached: we have a working application using React, React Router V4, Redux, and Saga. The code is split into several chunks, and these chunks are only called when necessary (depending on the routing). The stack works in server side rendering, too. And that' great.</p>\n<p>However, some issues are not completely resolved. The important choice of the HOC component allowing to call existing components asynchronously wasn't thought through properly. It is true that <code class=\"language-text\">loadable-components</code> was meeting specifications. But there are many others: <a href=\"https://github.com/faceyspacey/react-universal-component\">react-universal-component</a>, <a href=\"https://github.com/thejameskyle/react-loadable\">react-loadable</a>... We want to test all of them in production conditions to be serene about this choice.</p>\n<p>Second, server side rendering is an obvious strategy for SEO. But about performance, the arrival of <a href=\"https://www.youtube.com/watch?v=UhdGiVy3_Nk\">stream rendering</a> in the latest React version makes us want to continue experimenting further upstream before starting on a major optimization project.</p>\n<p>But when it comes to optimisation, there are countless ways forward: web workers, lazyloading, pure component, preact ... For example, I suggest you to read the excellent article <a href=\"https://medium.com/dev-channel/treebo-a-react-and-preact-progressive-web-app-performance-case-study-5e4f450d5299\">A React And Preact Progressive Web App Performance Case Study: Treebo</a>.</p>","frontmatter":{"title":"Running React Router v4, Redux Saga, SSR and Code Splitting together","date":"2017-10-17","tags":["react","tutorial"],"description":"Code splitting and server-side rendering are two ways of making a React app fast. Let's put them together in practice, with Redux, Sagas and React Router V4."}}},"pageContext":{"slug":"running-react-router-v4,-redux-saga,-ssr-and-code-splitting-together"}}